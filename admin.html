<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Admin Panel</title>
<link rel="stylesheet" href="theme.css">
<style>
  .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
  .tab{padding:8px 12px;border-radius:999px;cursor:pointer;background:rgba(255,255,255,0.06);font-weight:900;font-size:13px;}
  .tab.active{background:#ff5fa2;color:#111;}
  .list{display:flex;flex-direction:column;gap:8px;}
  .small{font-size:12px;opacity:.8;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
</style>
</head>
<body>

<div class="container">
  <h2>üõ°Ô∏è Admin Panel</h2>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="reports">üö® Reports</div>
    <div class="tab" data-tab="ban">‚õî Ban User</div>
    <div class="tab" data-tab="vip">üëë Set VIP</div>
    <div class="tab" data-tab="war">‚öîÔ∏è Reset War</div>
    <div class="tab" data-tab="logs">üßæ Logs</div>
  </div>

  <div id="content"></div>
  <p id="msg" class="muted"></p>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="vip.js"></script>
<script type="module" src="admin.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { VIP_TIERS } from "./vip.js";
  import {
    ADMIN_UIDS, isAdmin,
    banUser, unbanUser, adminSetVip,
    reviewReport, resetWarWeek, logAdmin, searchUsersByName
  } from "./admin.js";

  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, where, orderBy, limit, onSnapshot, getDoc, doc, getDocs
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const tabsEl=document.getElementById("tabs");
  const content=document.getElementById("content");
  const msgEl=document.getElementById("msg");

  let currentTab="reports";
  let unsub=null;

  tabsEl.onclick=(e)=>{
    const t=e.target.closest(".tab");
    if(!t) return;
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentTab=t.dataset.tab;
    loadTab();
  };

  onAuthStateChanged(auth, async (user)=>{
    if(!user){location.href="login.html";return;}
    if(!isAdmin(user.uid)){
      alert("B·∫°n kh√¥ng c√≥ quy·ªÅn admin."); location.href="index.html"; return;
    }
    loadTab();
  });

  function loadTab(){
    if(unsub) unsub();

    if(currentTab==="reports") return loadReports();
    if(currentTab==="ban") return renderBanTab();
    if(currentTab==="vip") return renderVipTab();
    if(currentTab==="war") return renderWarTab();
    if(currentTab==="logs") return loadLogs();
  }

  // ===== REPORTS TAB =====
  function loadReports(){
    content.innerHTML = `
      <div class="box">
        <div style="font-weight:900">Reports ƒëang ch·ªù duy·ªát</div>
        <div id="reportList" class="list" style="margin-top:8px;"></div>
        <p id="emptyReport" class="muted" style="display:none;">Kh√¥ng c√≥ report pending.</p>
      </div>
    `;
    const listEl=document.getElementById("reportList");
    const emptyEl=document.getElementById("emptyReport");

    const q=query(
      collection(db,"reports"),
      where("status","==","pending"),
      orderBy("createdAt","desc"),
      limit(50)
    );

    unsub=onSnapshot(q,(snap)=>{
      listEl.innerHTML="";
      if(snap.empty){ emptyEl.style.display="block"; return; }
      emptyEl.style.display="none";

      snap.forEach(d=>{
        const r=d.data();
        const time=r.createdAt?.toDate?r.createdAt.toDate().toLocaleString():"";
        const card=document.createElement("div");
        card.className="card fade-in";
        card.innerHTML=`
          <div><b>${r.reporterName||r.reporterUid}</b> b√°o c√°o <b>${r.targetName||r.targetUid}</b></div>
          <div class="small">L√Ω do: ${escapeHtml(r.reason||"")}</div>
          ${r.evidence?`<div class="small">B·∫±ng ch·ª©ng: ${escapeHtml(r.evidence)}</div>`:""}
          <div class="small muted">${time}</div>
          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
            <button class="btn" onclick="approveReport('${d.id}','${r.targetUid}')">‚úÖ Duy·ªát & Ban</button>
            <button class="btn light" onclick="rejectReport('${d.id}')">‚ùå T·ª´ ch·ªëi</button>
            <button class="btn light" onclick="viewUser('${r.targetUid}')">üë§ Xem user</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    });
  }

  window.approveReport = async (reportId, targetUid)=>{
    const note = prompt("Ghi ch√∫ admin (tu·ª≥ ch·ªçn):")||"";
    const reason = prompt("L√Ω do ban user:")||"Vi ph·∫°m";
    await reviewReport(reportId,"reviewed",note);
    await banUser(targetUid, reason);
    alert("ƒê√£ duy·ªát report v√† ban user.");
  };

  window.rejectReport = async (reportId)=>{
    const note = prompt("Ghi ch√∫ admin:")||"";
    await reviewReport(reportId,"rejected",note);
    alert("ƒê√£ t·ª´ ch·ªëi report.");
  };

  window.viewUser = (uid)=>{
    location.href=`profile_public.html?u=${uid}`;
  };

  // ===== BAN TAB =====
  function renderBanTab(){
    content.innerHTML=`
      <div class="box">
        <div style="font-weight:900;margin-bottom:6px;">T√¨m user</div>
        <input id="searchKey" placeholder="Nh·∫≠p t√™n user...">
        <button class="btn" style="margin-top:6px" onclick="searchUser()">üîé T√¨m</button>
        <div id="searchList" class="list" style="margin-top:8px;"></div>
      </div>
    `;
  }

  window.searchUser = async ()=>{
    const key=document.getElementById("searchKey").value.trim();
    const listEl=document.getElementById("searchList");
    listEl.innerHTML="ƒêang t√¨m...";

    const list = await searchUsersByName(key||"");
    if(list.length===0){
      listEl.innerHTML=`<div class="muted">Kh√¥ng t√¨m th·∫•y.</div>`;
      return;
    }

    listEl.innerHTML="";
    list.forEach(u=>{
      const card=document.createElement("div");
      card.className="row fade-in";
      card.innerHTML=`
        <img class="avatar" src="${u.avatar||'default.png'}" style="width:40px;height:40px;">
        <div style="flex:1">
          <div style="font-weight:900">${u.name||u.uid}</div>
          <div class="small muted">${u.uid}</div>
          <div class="small">Ban: <b>${u.isBanned?"YES":"NO"}</b></div>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn ${u.isBanned?'light':''}" onclick="doBan('${u.uid}')">${u.isBanned?'Ban l·∫°i':'Ban'}</button>
          <button class="btn light" onclick="doUnban('${u.uid}')">Unban</button>
        </div>
      `;
      listEl.appendChild(card);
    });
  };

  window.doBan = async (uid)=>{
    const r=prompt("L√Ω do ban:")||"Vi ph·∫°m";
    await banUser(uid,r);
    alert("ƒê√£ ban user.");
    searchUser();
  };

  window.doUnban = async (uid)=>{
    await unbanUser(uid);
    alert("ƒê√£ unban user.");
    searchUser();
  };

  // ===== VIP TAB =====
  function renderVipTab(){
    const tierOptions = Object.entries(VIP_TIERS).map(([k,t])=>{
      if(k==="0") return "";
      return `<option value="${k}">${k} - ${t.name}</option>`;
    }).join("");

    content.innerHTML=`
      <div class="box">
        <div style="font-weight:900;margin-bottom:6px;">Set VIP cho user</div>
        <input id="vipUid" placeholder="Nh·∫≠p UID user">
        <div class="grid2" style="margin-top:6px;">
          <select id="vipTier">${tierOptions}</select>
          <input id="vipDays" type="number" value="30" placeholder="S·ªë ng√†y">
        </div>
        <button class="btn" style="margin-top:8px" onclick="setVipAdmin()">üëë Set VIP</button>
        <p class="muted small">* Set VIP l√† ghi ƒë√® tier v√† h·∫°n m·ªõi.</p>
      </div>
    `;
  }

  window.setVipAdmin = async ()=>{
    const uid=document.getElementById("vipUid").value.trim();
    const tier=Number(document.getElementById("vipTier").value);
    const days=Number(document.getElementById("vipDays").value||30);

    if(!uid){alert("Thi·∫øu UID");return;}
    await adminSetVip(uid,tier,days);
    alert(`ƒê√£ set VIP tier ${tier} cho ${uid} (${days} ng√†y).`);
  };

  // ===== WAR TAB =====
  function renderWarTab(){
    content.innerHTML=`
      <div class="box">
        <div style="font-weight:900">Reset War tu·∫ßn</div>
        <div class="muted small">Sau khi b·∫°n ph√°t th∆∞·ªüng top5, b·∫•m n√∫t n√†y ƒë·ªÉ reset warPoints v·ªÅ 0.</div>
        <button class="btn red" style="margin-top:8px" onclick="resetWar()">‚öîÔ∏è Reset War</button>
      </div>
    `;
  }

  window.resetWar = async ()=>{
    if(!confirm("Reset t·∫•t c·∫£ warPoints?")) return;
    await resetWarWeek();
    alert("ƒê√£ reset war tu·∫ßn.");
  };

  // ===== LOGS TAB =====
  function loadLogs(){
    content.innerHTML=`
      <div class="box">
        <div style="font-weight:900">Admin Logs</div>
        <div id="logList" class="list" style="margin-top:8px;"></div>
      </div>
    `;
    const logList=document.getElementById("logList");

    const q=query(collection(db,"adminLogs"), orderBy("time","desc"), limit(50));
    unsub=onSnapshot(q,(snap)=>{
      logList.innerHTML="";
      snap.forEach(d=>{
        const l=d.data();
        const time=l.time?.toDate?l.time.toDate().toLocaleString():"";
        const row=document.createElement("div");
        row.className="row fade-in";
        row.innerHTML=`
          <div style="flex:1">
            <div><b>${l.adminName||l.adminUid}</b> ‚Üí <b>${l.action}</b></div>
            <div class="small muted">Target: ${l.targetUid||"-"}</div>
            <div class="small muted">${time}</div>
          </div>
          <div class="tag">log</div>
        `;
        logList.appendChild(row);
      });
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
</script>

</body>
</html>
