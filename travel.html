<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Du lá»‹ch áº£o</title>
<link rel="stylesheet" href="theme.css">
<style>
  .place-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  @media(max-width:700px){.place-grid{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>

<div class="container">
  <h2>âœˆï¸ Du lá»‹ch áº£o</h2>

  <div class="box">
    <div id="summary" class="muted">Äang táº£i...</div>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;margin-bottom:8px;">Chá»n Ä‘iá»ƒm Ä‘áº¿n</div>
    <div id="places" class="place-grid"></div>
    <p id="msg" class="muted"></p>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Ká»· niá»‡m du lá»‹ch</div>
    <div id="history"></div>
    <p id="empty" class="muted" style="display:none;">ChÆ°a cÃ³ chuyáº¿n Ä‘i nÃ o.</p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, setDoc, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const summaryEl=document.getElementById("summary");
  const placesEl=document.getElementById("places");
  const historyEl=document.getElementById("history");
  const emptyEl=document.getElementById("empty");
  const msgEl=document.getElementById("msg");

  let uid=null;
  let travel={history:[], totalTrips:0};

  const PLACES=[
    {id:"dalat", name:"ÄÃ  Láº¡t má»™ng mÆ¡", icon:"ğŸŒ²", cost:50, rewardPts:5},
    {id:"danang", name:"ÄÃ  Náºµng biá»ƒn", icon:"ğŸ–ï¸", cost:70, rewardPts:7},
    {id:"hanoi", name:"HÃ  Ná»™i phá»‘ cá»•", icon:"ğŸ®", cost:60, rewardPts:6},
    {id:"sg", name:"SÃ i GÃ²n night", icon:"ğŸŒƒ", cost:80, rewardPts:8},
    {id:"seoul", name:"Seoul vibe", icon:"ğŸ‡°ğŸ‡·", cost:120, rewardPts:12},
    {id:"paris", name:"Paris lÃ£ng máº¡n", icon:"ğŸ—¼", cost:180, rewardPts:20},
  ];

  onAuthStateChanged(auth, async (user)=>{
    if(!user){alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");location.href="login.html";return;}
    uid=user.uid;
    await ensureCoins();

    await loadTravel();
    renderAll();
  });

  async function loadTravel(){
    const ref=doc(db,"travels",uid);
    const snap=await getDoc(ref);
    travel=snap.exists()?snap.data():travel;
    if(!snap.exists()) await setDoc(ref, travel);
  }

  function renderAll(){
    renderSummary();
    renderPlaces();
    renderHistory();
  }

  function renderSummary(){
    summaryEl.innerHTML = `
      Báº¡n Ä‘Ã£ Ä‘i <b>${travel.totalTrips||0}</b> chuyáº¿n.
      <br>Style du lá»‹ch cá»™ng thÃªm vÃ o Style Points cá»§a báº¡n.
    `;
  }

  function renderPlaces(){
    placesEl.innerHTML="";
    PLACES.forEach(p=>{
      const card=document.createElement("div");
      card.className="card fade-in";
      card.innerHTML=`
        <div style="font-size:34px;text-align:center">${p.icon}</div>
        <div style="font-weight:900;text-align:center">${p.name}</div>
        <div class="muted" style="text-align:center">GiÃ¡: ${p.cost} xu</div>
        <div class="muted" style="text-align:center">+${p.rewardPts} style</div>
        <button class="btn" style="margin-top:6px" onclick="goTravel('${p.id}')">Äi ngay</button>
      `;
      placesEl.appendChild(card);
    });
  }

  function renderHistory(){
    historyEl.innerHTML="";
    const his=travel.history||[];
    if(his.length===0){ emptyEl.style.display="block"; return; }
    emptyEl.style.display="none";

    his.slice().reverse().forEach(h=>{
      const row=document.createElement("div");
      row.className="row fade-in";
      row.innerHTML=`
        <div style="font-size:28px">${h.icon}</div>
        <div style="flex:1">
          <div style="font-weight:900">${h.name}</div>
          <div class="muted">${h.note||""}</div>
        </div>
        <div class="muted" style="font-size:11px">${new Date(h.time).toLocaleString()}</div>
      `;
      historyEl.appendChild(row);
    });
  }

  window.goTravel = async (placeId)=>{
    const p=PLACES.find(x=>x.id===placeId);
    if(!p) return;

    const res=await spendCoins(p.cost);
    if(!res.ok){ alert("KhÃ´ng Ä‘á»§ xu Ä‘á»ƒ Ä‘i chÆ¡i!"); return; }

    const note = randomNote(p.name);

    travel.history = travel.history || [];
    travel.history.push({
      placeId:p.id, name:p.name, icon:p.icon,
      time:Date.now(), reward:p.rewardPts, note
    });
    travel.totalTrips = (travel.totalTrips||0)+1;

    await setDoc(doc(db,"travels",uid),travel,{merge:true});

    // cá»™ng style points vÃ o wardrobe náº¿u cÃ³
    try{
      await setDoc(doc(db,"wardrobe",uid),{
        stylePoints: increment(p.rewardPts)
      },{merge:true});
    }catch(e){}

    msgEl.style.color="lightgreen";
    msgEl.innerText=`âœˆï¸ Báº¡n Ä‘Ã£ Ä‘i ${p.name}! +${p.rewardPts} style.`;
    renderAll();
  };

  function randomNote(name){
    const n=[
      `Chá»¥p áº£nh Ä‘Ã´i á»Ÿ ${name} ğŸ“¸`,
      `Ä‚n Ä‘áº·c sáº£n táº¡i ${name} ğŸ˜‹`,
      `Gáº·p má»™t ngÆ°á»i dá»… thÆ°Æ¡ng á»Ÿ ${name} ğŸ’—`,
      `Ká»· niá»‡m Ä‘áº¹p táº¡i ${name} âœ¨`
    ];
    return n[Math.floor(Math.random()*n.length)];
  }
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("travel");
</script>

</body>
</html>
