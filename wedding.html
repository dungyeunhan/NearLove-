<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - ÄÃ¡m cÆ°á»›i</title>

<style>
  body{font-family:Arial;background:#0f1115;color:white;padding:16px;padding-bottom:80px;}
  h2{text-align:center;color:#ffd1e6;margin:8px 0 14px;}
  .box{
    max-width:900px;margin:0 auto 12px;background:#151824;
    padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);
  }
  .sub{font-size:14px;opacity:.85;line-height:1.5}
  select{
    width:100%;padding:12px;border-radius:10px;border:none;outline:none;
    background:rgba(255,255,255,0.08);color:white;font-size:15px;margin-top:8px;
  }
  .ring-list{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px;}
  .ring{
    background:rgba(255,255,255,0.06);padding:10px;border-radius:12px;
    border:1px solid transparent;cursor:pointer;display:flex;gap:8px;align-items:center;
  }
  .ring.active{border:1px solid #ff8ac9;background:rgba(255,61,127,0.18);}
  .ring .icon{font-size:26px;}
  .btn{
    width:100%;padding:12px;border:none;border-radius:12px;
    background:linear-gradient(135deg,#ff3d7f,#ff8ac9);color:white;font-weight:bold;
    font-size:16px;margin-top:10px;cursor:pointer;
  }
  .btn.light{background:rgba(255,255,255,0.1);}
  #msg{margin-top:8px;font-size:14px}
  .status{
    margin-top:8px;background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;
    font-size:14px;
  }
</style>
</head>
<body>

<h2>ğŸ’ Wedding NearLove</h2>

<!-- Tráº¡ng thÃ¡i -->
<div class="box">
  <div class="sub">Tráº¡ng thÃ¡i hÃ´n nhÃ¢n:</div>
  <div class="status" id="marriageStatus">Äang táº£i...</div>
</div>

<!-- Chá»n ngÆ°á»i Ä‘Ã£ match -->
<div class="box">
  <div class="sub">1) Chá»n ngÆ°á»i báº¡n muá»‘n cÆ°á»›i (chá»‰ hiá»‡n ngÆ°á»i Ä‘Ã£ match):</div>
  <select id="matchSelect">
    <option value="">-- Chá»n ngÆ°á»i Ä‘Ã£ match --</option>
  </select>
</div>

<!-- Chá»n nháº«n -->
<div class="box">
  <div class="sub">2) Chá»n nháº«n tá»« kho Ä‘á»“ cá»§a báº¡n:</div>
  <div class="ring-list" id="ringList"></div>
</div>

<!-- NÃºt cÆ°á»›i -->
<div class="box">
  <button class="btn" onclick="createWedding()">ğŸ’ Táº¡o lá»… cÆ°á»›i</button>
  <button class="btn light" onclick="cancelWedding()">ğŸ’” Huá»· hÃ´n / Ly hÃ´n (demo)</button>
  <p id="msg"></p>
</div>

<!-- Firebase -->
<script type="module" src="firebase.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, where, getDocs,
    doc, getDoc, setDoc, updateDoc, deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const matchSelect = document.getElementById("matchSelect");
  const ringListEl = document.getElementById("ringList");
  const msgEl = document.getElementById("msg");
  const statusEl = document.getElementById("marriageStatus");

  let myUid=null;
  let myProfile=null;
  let rings=[];
  let selectedRing=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    myUid = user.uid;

    // load há»“ sÆ¡ mÃ¬nh
    const meSnap = await getDoc(doc(db,"users",myUid));
    myProfile = meSnap.exists() ? meSnap.data() : {};

    renderMarriageStatus();

    // load danh sÃ¡ch match cá»§a mÃ¬nh
    await loadMatches();

    // load nháº«n trong kho Ä‘á»“
    await loadRings();
  });

  function renderMarriageStatus(){
    if(myProfile?.marriedTo){
      statusEl.innerHTML = `ğŸ’ Báº¡n Ä‘Ã£ káº¿t hÃ´n vá»›i UID: <b>${myProfile.marriedTo}</b><br>
      Wedding ID: ${myProfile.weddingId || "?"}`;
    }else{
      statusEl.innerText = "ChÆ°a káº¿t hÃ´n.";
    }
  }

  async function loadMatches(){
    matchSelect.innerHTML = `<option value="">-- Chá»n ngÆ°á»i Ä‘Ã£ match --</option>`;
    const q = query(collection(db,"matches"), where("users","array-contains",myUid));
    const snap = await getDocs(q);

    snap.forEach(d=>{
      const data = d.data();
      const otherUid = data.users.find(u=>u!==myUid);

      const opt = document.createElement("option");
      opt.value = otherUid;
      opt.textContent = otherUid; // MVP hiá»ƒn thá»‹ uid (sau sáº½ hiá»‡n tÃªn)
      matchSelect.appendChild(opt);
    });
  }

  async function loadRings(){
    ringListEl.innerHTML = "";
    const invSnap = await getDoc(doc(db,"inventories",myUid));
    const items = invSnap.exists() ? (invSnap.data().items || []) : [];

    rings = items.filter(i=> (i.type||"").toLowerCase().includes("wedding") || (i.id||"").includes("ring"));

    if(rings.length===0){
      ringListEl.innerHTML = `<div class="sub">Báº¡n chÆ°a cÃ³ nháº«n. VÃ o Shop mua nháº«n trÆ°á»›c nhÃ© ğŸ’</div>`;
      return;
    }

    rings.forEach((r, idx)=>{
      const div = document.createElement("div");
      div.className="ring";
      div.innerHTML = `
        <div class="icon">${r.icon||"ğŸ’"}</div>
        <div>
          <b>${r.name}</b><br>
          <span class="sub">${r.price || 0} xu</span>
        </div>
      `;
      div.onclick=()=>{
        document.querySelectorAll(".ring").forEach(x=>x.classList.remove("active"));
        div.classList.add("active");
        selectedRing = r;
      };
      ringListEl.appendChild(div);

      if(idx===0){
        div.classList.add("active");
        selectedRing = r;
      }
    });
  }

  // Táº¡o lá»… cÆ°á»›i
  window.createWedding = async ()=>{
    msgEl.innerText="";
    const partnerUid = matchSelect.value;

    if(!partnerUid){
      msgEl.style.color="red";
      msgEl.innerText="Báº¡n chÆ°a chá»n ngÆ°á»i Ä‘á»ƒ cÆ°á»›i.";
      return;
    }
    if(!selectedRing){
      msgEl.style.color="red";
      msgEl.innerText="Báº¡n chÆ°a chá»n nháº«n.";
      return;
    }

    // cháº·n náº¿u mÃ¬nh Ä‘Ã£ káº¿t hÃ´n
    if(myProfile?.marriedTo){
      msgEl.style.color="red";
      msgEl.innerText="Báº¡n Ä‘ang cÃ³ hÃ´n nhÃ¢n rá»“i. Huá»· hÃ´n trÆ°á»›c khi cÆ°á»›i má»›i.";
      return;
    }

    // kiá»ƒm tra Ä‘á»‘i phÆ°Æ¡ng cÃ³ Ä‘ang káº¿t hÃ´n khÃ´ng
    const pSnap = await getDoc(doc(db,"users",partnerUid));
    const pData = pSnap.exists()?pSnap.data():{};
    if(pData?.marriedTo){
      msgEl.style.color="red";
      msgEl.innerText="NgÆ°á»i nÃ y Ä‘Ã£ káº¿t hÃ´n vá»›i ngÆ°á»i khÃ¡c.";
      return;
    }

    // weddingId cá»‘ Ä‘á»‹nh theo cáº·p Ä‘á»ƒ trÃ¡nh trÃ¹ng
    const weddingId = `${myUid}_${partnerUid}`;

    // táº¡o wedding
    await setDoc(doc(db,"weddings", weddingId),{
      users:[myUid, partnerUid],
      ringId: selectedRing.id,
      ringName: selectedRing.name,
      ringIcon: selectedRing.icon,
      createdAt: serverTimestamp()
    });

    // update cáº£ 2 user
    await updateDoc(doc(db,"users", myUid),{
      marriedTo: partnerUid,
      weddingId
    });
    await updateDoc(doc(db,"users", partnerUid),{
      marriedTo: myUid,
      weddingId
    });

    msgEl.style.color="lightgreen";
    msgEl.innerText="ğŸ‰ Táº¡o lá»… cÆ°á»›i thÃ nh cÃ´ng! ChÃºc má»«ng 2 báº¡n ğŸ’•";

    // reload tráº¡ng thÃ¡i
    myProfile.marriedTo = partnerUid;
    myProfile.weddingId = weddingId;
    renderMarriageStatus();
  };

  // Huá»· hÃ´n (demo MVP)
  window.cancelWedding = async ()=>{
    if(!myProfile?.marriedTo){
      msgEl.style.color="red";
      msgEl.innerText="Báº¡n chÆ°a káº¿t hÃ´n.";
      return;
    }

    const partnerUid = myProfile.marriedTo;
    const weddingId = myProfile.weddingId;

    // xoÃ¡ wedding doc
    if(weddingId){
      await deleteDoc(doc(db,"weddings", weddingId));
    }

    // xoÃ¡ tráº¡ng thÃ¡i hÃ´n nhÃ¢n cá»§a 2 bÃªn
    await updateDoc(doc(db,"users", myUid),{
      marriedTo: null,
      weddingId: null
    });
    await updateDoc(doc(db,"users", partnerUid),{
      marriedTo: null,
      weddingId: null
    });

    msgEl.style.color="#ffd1e6";
    msgEl.innerText="ğŸ’” ÄÃ£ huá»· hÃ´n (demo).";

    myProfile.marriedTo=null;
    myProfile.weddingId=null;
    renderMarriageStatus();
  };
</script>

</body>
</html>
