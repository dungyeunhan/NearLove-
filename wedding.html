<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - HÃ´n lá»…</title>
<link rel="stylesheet" href="theme.css">
<style>
  .req-card{display:flex;flex-direction:column;gap:6px;}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ’ HÃ´n lá»… NearLove</h2>

  <div class="box" id="myStatus">Äang táº£i...</div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Lá»i cáº§u hÃ´n gá»­i Ä‘áº¿n báº¡n</div>
    <div id="reqList" style="margin-top:8px;"></div>
    <p id="emptyReq" class="muted" style="display:none;">ChÆ°a cÃ³ lá»i cáº§u hÃ´n nÃ o.</p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, where, onSnapshot, addDoc,
    doc, getDoc, setDoc, updateDoc, serverTimestamp, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const myStatus=document.getElementById("myStatus");
  const reqList=document.getElementById("reqList");
  const emptyReq=document.getElementById("emptyReq");

  let uid=null, me=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    uid=user.uid;

    const meSnap=await getDoc(doc(db,"users",uid));
    me=meSnap.exists()?meSnap.data():{};
    renderMyStatus();

    // nghe lá»i cáº§u hÃ´n tá»›i mÃ¬nh
    const rq = query(
      collection(db,"weddingRequests"),
      where("toUid","==",uid),
      where("status","==","pending")
    );

    onSnapshot(rq,(snap)=>{
      reqList.innerHTML="";
      if(snap.empty){ emptyReq.style.display="block"; return; }
      emptyReq.style.display="none";

      snap.forEach(d=>{
        const r=d.data(); const id=d.id;
        const card=document.createElement("div");
        card.className="card req-card fade-in";
        card.innerHTML=`
          <div style="display:flex;gap:10px;align-items:center;">
            <img class="avatar" src="${r.fromAvatar||'default.png'}" style="width:52px;height:52px;">
            <div style="flex:1;">
              <div style="font-weight:900;font-size:16px;">${r.fromName||"Ai Ä‘Ã³"}</div>
              <div class="muted">muá»‘n káº¿t hÃ´n vá»›i báº¡n ğŸ’—</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;">
            <button class="btn" onclick="acceptReq('${id}')">âœ… Äá»“ng Ã½</button>
            <button class="btn light" onclick="rejectReq('${id}')">âŒ Tá»« chá»‘i</button>
          </div>
        `;
        reqList.appendChild(card);
      });
    });
  });

  function renderMyStatus(){
    if(me.marriedTo && me.weddingId){
      myStatus.innerHTML=`
        <div style="font-weight:900;font-size:18px;">Báº¡n Ä‘Ã£ káº¿t hÃ´n ğŸ’</div>
        <div class="muted">WeddingID: ${me.weddingId}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <a class="btn blue" href="wedding_room.html?w=${me.weddingId}">ğŸ° VÃ o phÃ²ng cÆ°á»›i</a>
          <button class="btn light" onclick="divorce()">ğŸ’” Ly hÃ´n (demo)</button>
        </div>
      `;
    }else{
      myStatus.innerHTML=`
        <div style="font-weight:900;font-size:18px;">Báº¡n chÆ°a káº¿t hÃ´n</div>
        <div class="muted">HÃ£y vÃ o há»“ sÆ¡ ngÆ°á»i báº¡n thÃ­ch Ä‘á»ƒ cáº§u hÃ´n nhÃ©.</div>
      `;
    }
  }

  // ===== ACCEPT =====
  window.acceptReq = async (reqId)=>{
    if(me.marriedTo){
      alert("Báº¡n Ä‘Ã£ káº¿t hÃ´n rá»“i."); return;
    }

    const rSnap=await getDoc(doc(db,"weddingRequests",reqId));
    if(!rSnap.exists()) return;
    const r=rSnap.data();

    const fromUid=r.fromUid;
    const fromSnap=await getDoc(doc(db,"users",fromUid));
    const from=fromSnap.exists()?fromSnap.data():{};

    if(from.marriedTo){
      alert("NgÆ°á»i kia Ä‘Ã£ káº¿t hÃ´n vá»›i ngÆ°á»i khÃ¡c."); 
      await updateDoc(doc(db,"weddingRequests",reqId),{status:"rejected"});
      return;
    }

    // táº¡o weddingId
    const weddingId = `${fromUid}_${uid}`;

    // táº¡o wedding document
    await setDoc(doc(db,"weddings",weddingId),{
      aUid: fromUid, bUid: uid,
      aName: from.name||"A", bName: me.name||"B",
      aAvatar: from.avatar||"default.png",
      bAvatar: me.avatar||"default.png",
      createdAt: serverTimestamp(),
      giftsTotal: 0
    });

    // update 2 user
    await updateDoc(doc(db,"users",uid),{
      marriedTo: fromUid,
      weddingId
    });
    await updateDoc(doc(db,"users",fromUid),{
      marriedTo: uid,
      weddingId
    });

    // update req
    await updateDoc(doc(db,"weddingRequests",reqId),{status:"accepted"});

    alert("ğŸ‰ Káº¿t hÃ´n thÃ nh cÃ´ng! VÃ o phÃ²ng cÆ°á»›i thÃ´i!");
    location.reload();
  };

  // ===== REJECT =====
  window.rejectReq = async (reqId)=>{
    await updateDoc(doc(db,"weddingRequests",reqId),{status:"rejected"});
    alert("Báº¡n Ä‘Ã£ tá»« chá»‘i lá»i cáº§u hÃ´n.");
  };

  // ===== DIVORCE (demo) =====
  window.divorce = async ()=>{
    if(!confirm("Ly hÃ´n demo sáº½ xoÃ¡ cÆ°á»›i. Báº¡n cháº¯c chÆ°a?")) return;

    const otherUid=me.marriedTo;
    const weddingId=me.weddingId;

    // xoÃ¡ wedding doc + gifts (MVP chá»‰ xoÃ¡ wedding doc)
    await deleteDoc(doc(db,"weddings",weddingId)).catch(()=>{});

    await updateDoc(doc(db,"users",uid),{marriedTo:null,weddingId:null});
    if(otherUid){
      await updateDoc(doc(db,"users",otherUid),{marriedTo:null,weddingId:null}).catch(()=>{});
    }

    alert("ğŸ’” ÄÃ£ ly hÃ´n.");
    location.reload();
  };
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("home");
</script>

</body>
</html>
