<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Th么ng b谩o</title>
<link rel="stylesheet" href="theme.css">
<style>
  .noti{display:flex;gap:10px;align-items:flex-start;}
  .noti.unread{background:rgba(255,95,162,0.08);border:1px solid rgba(255,95,162,0.35);}
  .noti .icon{font-size:22px;width:26px;text-align:center;}
</style>
</head>
<body>

<div class="container">
  <h2> Th么ng b谩o</h2>
  <div id="list"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">Ch瓢a c贸 th么ng b谩o.</p>
</div>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot,
    doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const listEl=document.getElementById("list");
  const emptyEl=document.getElementById("empty");

  onAuthStateChanged(auth,(user)=>{
    if(!user){location.href="login.html";return;}
    const uid=user.uid;

    const q=query(
      collection(db,"notifications",uid,"items"),
      orderBy("createdAt","desc")
    );

    onSnapshot(q,(snap)=>{
      listEl.innerHTML="";
      if(snap.empty){ emptyEl.style.display="block"; return; }
      emptyEl.style.display="none";

      snap.forEach(d=>{
        const n=d.data();
        const timeStr = n.createdAt?.toDate
          ? n.createdAt.toDate().toLocaleString()
          : "";

        const row=document.createElement("div");
        row.className=`row noti fade-in ${n.isRead?"":"unread"}`;
        row.innerHTML=`
          <div class="icon">${n.icon||""}</div>
          <div style="flex:1">
            <div style="font-weight:900">${escapeHtml(n.title||"")}</div>
            <div>${escapeHtml(n.body||"")}</div>
            <div class="muted" style="font-size:11px;margin-top:2px;">${timeStr}</div>
          </div>
          ${n.link?`<a class="tag" href="${n.link}">Xem</a>`:""}
        `;

        row.onclick=async ()=>{
          if(!n.isRead){
            await updateDoc(doc(db,"notifications",uid,"items",d.id),{isRead:true});
          }
          if(n.link) location.href=n.link;
        };

        listEl.appendChild(row);
      });
    });
  });

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("noti");
</script>

</body>
</html>
