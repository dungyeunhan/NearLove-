<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - ThÃ´ng bÃ¡o</title>
<link rel="stylesheet" href="theme.css">
<style>
  .noti{cursor:pointer;}
  .noti.unread{border:1px solid rgba(255,138,201,0.6);}
  .dot{
    width:8px;height:8px;border-radius:50%;background:#ff3d7f;display:inline-block;margin-right:6px;
  }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ”” ThÃ´ng bÃ¡o</h2>
  <div id="notiList"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">ChÆ°a cÃ³ thÃ´ng bÃ¡o nÃ o.</p>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="notify.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { markRead } from "./notify.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const listEl = document.getElementById("notiList");
  const emptyEl = document.getElementById("empty");
  let uid=null;

  onAuthStateChanged(auth,(user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    uid=user.uid;

    const q = query(
      collection(db,"notifications",uid,"items"),
      orderBy("createdAt","desc")
    );

    onSnapshot(q,(snap)=>{
      listEl.innerHTML="";
      if(snap.empty){ emptyEl.style.display="block"; return; }
      emptyEl.style.display="none";

      snap.forEach(d=>{
        const n=d.data();
        const id=d.id;

        const row=document.createElement("div");
        row.className="row noti fade-in "+(n.read?"":"unread");

        const timeStr = n.createdAt?.toDate
          ? n.createdAt.toDate().toLocaleString()
          : "";

        row.innerHTML=`
          <img class="avatar" src="${n.fromAvatar||'default.png'}" style="width:48px;height:48px;">
          <div style="flex:1">
            <div style="font-weight:900">
              ${n.read?"":"<span class='dot'></span>"}
              ${n.fromName||"Ai Ä‘Ã³"}
            </div>
            <div class="muted">${renderText(n)}</div>
            <div class="muted" style="font-size:11px;margin-top:4px;">${timeStr}</div>
          </div>
        `;

        row.onclick = async ()=>{
          if(!n.read) await markRead(uid,id);

          // Äiá»u hÆ°á»›ng theo loáº¡i noti
          if(n.type==="like"){
            location.href = `profile_public.html?uid=${n.fromUid}`;
          }
          if(n.type==="match"){
            location.href = `chat.html?match=${n.matchId}`;
          }
          if(n.type==="message"){
            location.href = `chat.html?match=${n.matchId}`;
          }
        };

        listEl.appendChild(row);
      });
    });
  });

  function renderText(n){
    if(n.type==="like") return "Ä‘Ã£ tháº£ tim báº¡n ğŸ’—";
    if(n.type==="match") return "Ä‘Ã£ match vá»›i báº¡n ğŸ‰";
    if(n.type==="message") return `nháº¯n: "${n.text||""}" ğŸ’¬`;
    return n.text||"";
  }
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("noti");
</script>

</body>
</html>
