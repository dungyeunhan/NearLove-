<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Quáº£n trá»‹ Bang</title>
<link rel="stylesheet" href="theme.css">
<style>
  .member-row{display:flex;align-items:center;gap:8px;justify-content:space-between;}
  .left{display:flex;align-items:center;gap:8px;}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ› ï¸ Quáº£n trá»‹ Bang</h2>

  <div class="box" id="guildInfo">Äang táº£i...</div>

  <!-- Donate -->
  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Donate vÃ o quá»¹ bang</div>
    <input id="donateAmt" type="number" placeholder="Nháº­p sá»‘ xu donate">
    <button class="btn" onclick="donate()">ğŸ’° Donate</button>
    <div class="muted">* Xu donate sáº½ chuyá»ƒn tá»« báº¡n sang quá»¹ bang.</div>
  </div>

  <!-- Quáº£n trá»‹ trÆ°á»Ÿng bang -->
  <div class="box" id="ownerBox" style="margin-top:10px;display:none;">
    <div style="font-weight:900;margin-bottom:8px;">Chá»‰ trÆ°á»Ÿng bang má»›i tháº¥y pháº§n nÃ y</div>
    <div id="memberList"></div>

    <button class="btn red" style="margin-top:10px;" onclick="disbandGuild()">
      ğŸ§¨ Giáº£i tÃ¡n bang
    </button>
  </div>

  <p id="msg" class="muted" style="margin-top:8px;"></p>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, updateDoc, deleteDoc,
    collection, getDocs,
    increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const guildInfoEl = document.getElementById("guildInfo");
  const ownerBox = document.getElementById("ownerBox");
  const memberListEl = document.getElementById("memberList");
  const msgEl = document.getElementById("msg");

  let uid=null, me=null, guildId=null, guild=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    uid=user.uid;
    await ensureCoins();

    const meSnap = await getDoc(doc(db,"users",uid));
    me = meSnap.exists()?meSnap.data():{};
    guildId = me.guildId;

    if(!guildId){
      alert("Báº¡n chÆ°a vÃ o bang nÃ o.");
      location.href="guild.html";
      return;
    }

    const gSnap = await getDoc(doc(db,"guilds",guildId));
    guild = gSnap.exists()?gSnap.data():{};
    renderGuildInfo();

    if(guild.ownerUid===uid){
      ownerBox.style.display="block";
      renderMembers();
    }
  });

  function renderGuildInfo(){
    guildInfoEl.innerHTML = `
      <div style="font-weight:900;font-size:18px;">
        ${guild.badge||"ğŸ°"} ${guild.name||"Bang há»™i"}
      </div>
      <div class="muted">
        TrÆ°á»Ÿng bang: ${guild.ownerUid}<br>
        ThÃ nh viÃªn: ${(guild.members||[]).length}<br>
        Quá»¹ bang: <b>${guild.coinsPool||0}</b> xu
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
        <a class="btn light" href="guild.html">â† Vá» Bang</a>
        <a class="btn light" href="guild_shop.html">ğŸ›’ Shop Bang</a>
        <a class="btn light" href="guild_mission.html">ğŸ“œ Nhiá»‡m vá»¥</a>
      </div>
    `;
  }

  async function renderMembers(){
    memberListEl.innerHTML="Äang táº£i danh sÃ¡ch...";
    const members = guild.members||[];

    let html="";
    for(const mUid of members){
      const uSnap = await getDoc(doc(db,"users",mUid));
      const u = uSnap.exists()?uSnap.data():{};
      const isOwner = mUid===guild.ownerUid;

      html += `
        <div class="row member-row fade-in">
          <div class="left">
            <img class="avatar" src="${u.avatar||'default.png'}" style="width:42px;height:42px;">
            <div>
              <div style="font-weight:900">${u.name||mUid} ${isOwner?"ğŸ‘‘":""}</div>
              <div class="muted" style="font-size:12px;">${mUid}</div>
            </div>
          </div>
          ${
            isOwner ? `<div class="tag">TrÆ°á»Ÿng bang</div>`
            : `<button class="btn light" style="width:auto;" onclick="transferOwner('${mUid}')">Chuyá»ƒn trÆ°á»Ÿng</button>`
          }
        </div>
      `;
    }

    memberListEl.innerHTML = html;
  }

  // ===== DONATE =====
  window.donate = async ()=>{
    const amt = Number(document.getElementById("donateAmt").value||0);
    if(amt<=0){ msgEl.style.color="red"; msgEl.innerText="Sá»‘ xu donate khÃ´ng há»£p lá»‡."; return; }

    const res = await spendCoins(amt);
    if(!res.ok){ msgEl.style.color="red"; msgEl.innerText="KhÃ´ng Ä‘á»§ xu Ä‘á»ƒ donate."; return; }

    await updateDoc(doc(db,"guilds",guildId),{
      coinsPool: increment(amt),
      updatedAt: serverTimestamp()
    });

    msgEl.style.color="lightgreen";
    msgEl.innerText=`âœ… Donate thÃ nh cÃ´ng +${amt} xu vÃ o quá»¹ bang!`;
    document.getElementById("donateAmt").value="";

    // reload quá»¹
    const gSnap = await getDoc(doc(db,"guilds",guildId));
    guild = gSnap.data();
    renderGuildInfo();
  };

  // ===== CHUYá»‚N TRÆ¯á»NG =====
  window.transferOwner = async (newOwnerUid)=>{
    if(!confirm("Chuyá»ƒn trÆ°á»Ÿng bang cho ngÆ°á»i nÃ y?")) return;

    await updateDoc(doc(db,"guilds",guildId),{
      ownerUid: newOwnerUid,
      updatedAt: serverTimestamp()
    });

    alert("âœ… ÄÃ£ chuyá»ƒn trÆ°á»Ÿng bang!");
    location.reload();
  };

  // ===== GIáº¢I TÃN BANG =====
  window.disbandGuild = async ()=>{
    if(!confirm("Giáº£i tÃ¡n bang sáº½ xoÃ¡ bang vÃ  gá»¡ táº¥t cáº£ thÃ nh viÃªn. Cháº¯c chÆ°a?")) return;

    const members = guild.members||[];

    // gá»¡ guild khá»i tá»«ng user
    for(const mUid of members){
      await updateDoc(doc(db,"users",mUid),{
        guildId: null, guildName: null, guildBadge: null
      }).catch(()=>{});
    }

    // xoÃ¡ bang
    await deleteDoc(doc(db,"guilds",guildId));

    alert("ğŸ§¨ Bang Ä‘Ã£ bá»‹ giáº£i tÃ¡n.");
    location.href="guild.html";
  };
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("guild");
</script>

</body>
</html>
