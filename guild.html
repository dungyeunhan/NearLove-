<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Bang há»™i</title>
<link rel="stylesheet" href="theme.css">
<style>
  .guild-card{display:flex;flex-direction:column;gap:6px;}
  .guild-title{font-weight:900;font-size:18px;}
  .badge{font-size:22px;margin-right:6px;}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ° Bang há»™i NearLove</h2>

  <!-- Tráº¡ng thÃ¡i bang cá»§a mÃ¬nh -->
  <div class="box" id="myGuildBox">Äang táº£i...</div>

  <!-- Táº¡o bang -->
  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Táº¡o bang má»›i (tá»‘n 500 xu)</div>
    <input id="gName" placeholder="TÃªn bang (vd: Love Kings)">
    <input id="gBadge" placeholder="Badge/emoji (vd: ğŸ‘‘, ğŸ‰)">
    <input id="gDesc" placeholder="MÃ´ táº£ ngáº¯n">
    <button class="btn" onclick="createGuild()">â• Táº¡o bang</button>
    <div class="muted">* Má»—i ngÆ°á»i chá»‰ thuá»™c 1 bang.</div>
  </div>

  <!-- TÃ¬m bang -->
  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">TÃ¬m bang</div>
    <input id="search" placeholder="Nháº­p tÃªn bang...">
    <button class="btn light" onclick="renderGuilds()">TÃ¬m</button>
  </div>

  <!-- Danh sÃ¡ch bang -->
  <div id="guildList" class="grid-2" style="margin-top:10px;"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">ChÆ°a cÃ³ bang nÃ o.</p>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins, getCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, orderBy, onSnapshot, addDoc,
    doc, getDoc, setDoc, updateDoc, serverTimestamp, arrayUnion, arrayRemove
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const myGuildBox = document.getElementById("myGuildBox");
  const guildList = document.getElementById("guildList");
  const emptyEl = document.getElementById("empty");
  const searchEl = document.getElementById("search");

  let uid=null;
  let me=null;
  let allGuilds=[];
  let unsub=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    uid=user.uid;

    await ensureCoins();

    const meSnap = await getDoc(doc(db,"users",uid));
    me = meSnap.exists()?meSnap.data():{};
    renderMyGuild();

    subscribeGuilds();
  });

  function subscribeGuilds(){
    const q = query(collection(db,"guilds"), orderBy("createdAt","desc"));
    unsub = onSnapshot(q,(snap)=>{
      allGuilds=[];
      snap.forEach(d=> allGuilds.push({id:d.id, ...d.data()}));
      renderGuilds();
    });
  }

  function renderMyGuild(){
    if(me.guildId){
      myGuildBox.innerHTML = `
        <div style="font-weight:900;font-size:18px;">
          ${me.guildBadge||"ğŸ°"} ${me.guildName||"Bang cá»§a báº¡n"}
        </div>
        <div class="muted">Báº¡n Ä‘ang thuá»™c bang nÃ y.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button class="btn blue" onclick="goChat()">ğŸ’¬ Chat bang</button>
          <button class="btn light" onclick="leaveGuild()">ğŸšª Rá»i bang</button>
        </div>
      `;
    }else{
      myGuildBox.innerHTML = `
        <div style="font-weight:900;">Báº¡n chÆ°a vÃ o bang nÃ o.</div>
        <div class="muted">HÃ£y chá»n 1 bang bÃªn dÆ°á»›i hoáº·c táº¡o bang má»›i.</div>
      `;
    }
  }

  window.renderGuilds = ()=>{
    const kw = searchEl.value.trim().toLowerCase();
    const list = kw
      ? allGuilds.filter(g=>(g.name||"").toLowerCase().includes(kw))
      : allGuilds;

    guildList.innerHTML="";
    if(list.length===0){
      emptyEl.style.display="block";
      return;
    }
    emptyEl.style.display="none";

    list.forEach(g=>{
      const isMember = (g.members||[]).includes(uid);
      const isOwner = g.ownerUid===uid;

      const card=document.createElement("div");
      card.className="card guild-card fade-in";
      card.innerHTML=`
        <div class="guild-title">
          <span class="badge">${g.badge||"ğŸ°"}</span>
          ${g.name}
        </div>
        <div class="muted">${g.desc||"ChÆ°a cÃ³ mÃ´ táº£"}</div>
        <div class="muted">ThÃ nh viÃªn: <b>${(g.members||[]).length}</b> â€¢ Lv.${g.level||1}</div>

        ${
          me.guildId
          ? `<button class="btn light" disabled>Báº¡n Ä‘Ã£ á»Ÿ bang khÃ¡c</button>`
          : isMember
            ? `<button class="btn light" disabled>ÄÃ£ vÃ o</button>`
            : `<button class="btn" onclick="joinGuild('${g.id}')">âœ… Xin vÃ o bang</button>`
        }

        ${isOwner ? `<div class="tag" style="margin-top:4px;">TrÆ°á»Ÿng bang</div>`:``}
      `;
      guildList.appendChild(card);
    });
  };

  // Táº O BANG
  window.createGuild = async ()=>{
    if(me.guildId){
      alert("Báº¡n Ä‘ang á»Ÿ trong 1 bang rá»“i. Rá»i bang trÆ°á»›c.");
      return;
    }
    const name = document.getElementById("gName").value.trim();
    const badge = document.getElementById("gBadge").value.trim() || "ğŸ°";
    const desc  = document.getElementById("gDesc").value.trim();

    if(name.length<3){
      alert("TÃªn bang tá»‘i thiá»ƒu 3 kÃ½ tá»±.");
      return;
    }

    const fee = 500;
    const res = await spendCoins(fee);
    if(!res.ok){
      alert("KhÃ´ng Ä‘á»§ xu Ä‘á»ƒ táº¡o bang. Cáº§n 500 xu.");
      return;
    }

    const gRef = await addDoc(collection(db,"guilds"),{
      name, badge, desc,
      ownerUid: uid,
      members: [uid],
      level: 1,
      coinsPool: 0,
      createdAt: serverTimestamp()
    });

    await updateDoc(doc(db,"users",uid),{
      guildId: gRef.id,
      guildName: name,
      guildBadge: badge
    });

    alert("ğŸ‰ Táº¡o bang thÃ nh cÃ´ng!");
    location.reload();
  };

  // XIN VÃ€O BANG
  window.joinGuild = async (guildId)=>{
    if(me.guildId){
      alert("Báº¡n Ä‘Ã£ á»Ÿ bang khÃ¡c rá»“i.");
      return;
    }

    const gSnap = await getDoc(doc(db,"guilds",guildId));
    if(!gSnap.exists()){ alert("Bang khÃ´ng tá»“n táº¡i."); return; }
    const g = gSnap.data();

    await updateDoc(doc(db,"guilds",guildId),{
      members: arrayUnion(uid)
    });

    await updateDoc(doc(db,"users",uid),{
      guildId,
      guildName: g.name,
      guildBadge: g.badge||"ğŸ°"
    });

    alert("âœ… Báº¡n Ä‘Ã£ vÃ o bang!");
    location.reload();
  };

  // Rá»œI BANG
  window.leaveGuild = async ()=>{
    if(!me.guildId) return;

    const guildId = me.guildId;
    const gSnap = await getDoc(doc(db,"guilds",guildId));
    if(!gSnap.exists()){ alert("Bang khÃ´ng tá»“n táº¡i."); return; }
    const g = gSnap.data();

    // Náº¿u lÃ  trÆ°á»Ÿng bang vÃ  cÃ²n ngÆ°á»i khÃ¡c -> cháº·n rá»i (MVP)
    const members = g.members || [];
    if(g.ownerUid===uid && members.length>1){
      alert("Báº¡n lÃ  trÆ°á»Ÿng bang. HÃ£y chuyá»ƒn trÆ°á»Ÿng (sau nÃ¢ng cáº¥p) hoáº·c giáº£i tÃ¡n.");
      return;
    }

    // remove khá»i members
    await updateDoc(doc(db,"guilds",guildId),{
      members: arrayRemove(uid)
    });

    // xoÃ¡ guild khá»i user
    await updateDoc(doc(db,"users",uid),{
      guildId: null,
      guildName: null,
      guildBadge: null
    });

    alert("ğŸšª Báº¡n Ä‘Ã£ rá»i bang!");
    location.reload();
  };

  window.goChat = ()=> location.href="guild_chat.html";
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("guild");
</script>

</body>
</html>
