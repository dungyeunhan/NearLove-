<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Sá»± kiá»‡n & BXH</title>

<style>
  body{
    font-family:Arial;background:#0f1115;color:white;
    padding:16px;padding-bottom:80px;
  }
  h2{text-align:center;color:#ffd1e6;margin:8px 0 14px;}
  .tabs{
    max-width:1000px;margin:0 auto 12px;
    display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
  }
  .tab{
    padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:bold;
    background:rgba(255,255,255,0.08);opacity:.9;
  }
  .tab.active{
    background:linear-gradient(135deg,#ff3d7f,#ff8ac9);
    opacity:1;
  }
  .box{
    max-width:1000px;margin:0 auto 12px;background:#151824;
    padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);
  }
  .row{
    display:flex;align-items:center;gap:10px;
    padding:10px;border-radius:12px;background:rgba(255,255,255,0.04);
    margin-bottom:8px;
  }
  .rank{
    width:36px;height:36px;border-radius:10px;display:grid;place-items:center;
    font-weight:900;background:rgba(255,255,255,0.12);
  }
  .avatar{
    width:48px;height:48px;border-radius:12px;object-fit:cover;
    background:#222;
  }
  .name{font-weight:900;font-size:16px;}
  .sub{font-size:13px;opacity:.85;line-height:1.4;}
  .vip{font-weight:900;margin-left:6px;}
  .gold{color:#ffd700;}
  .pink{color:#ff8ac9;}
  .muted{opacity:.7;}
</style>
</head>
<body>

<h2>ğŸ† Sá»± kiá»‡n & Báº£ng xáº¿p háº¡ng</h2>

<div class="tabs">
  <div class="tab active" data-tab="rich">ğŸ’° Äáº¡i gia</div>
  <div class="tab" data-tab="vip">ğŸ‘‘ VIP</div>
  <div class="tab" data-tab="couple">ğŸ’ Cáº·p Ä‘Ã´i</div>
</div>

<div class="box" id="content">
  Äang táº£i...
</div>

<!-- Firebase -->
<script type="module" src="firebase.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, orderBy, limit, onSnapshot, where, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const content = document.getElementById("content");
  const tabs = document.querySelectorAll(".tab");

  let currentTab = "rich";
  let unsub = null;

  tabs.forEach(t=>{
    t.onclick=()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      currentTab = t.dataset.tab;
      loadTab();
    };
  });

  onAuthStateChanged(auth, (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    loadTab();
  });

  function loadTab(){
    if(unsub) unsub();

    if(currentTab==="rich") loadRich();
    if(currentTab==="vip") loadVip();
    if(currentTab==="couple") loadCouple();
  }

  // ===== BXH Äáº I GIA (coins) =====
  function loadRich(){
    const q = query(
      collection(db, "users"),
      orderBy("coins","desc"),
      limit(20)
    );

    unsub = onSnapshot(q, (snap)=>{
      const list=[];
      snap.forEach(d=> list.push({uid:d.id, ...d.data()}));
      renderUsers(list, (u)=>`ğŸ’° ${u.coins||0} xu`);
    });
  }

  // ===== BXH VIP (vipTier) =====
  function loadVip(){
    const q = query(
      collection(db, "users"),
      orderBy("vipTier","desc"),
      limit(20)
    );

    unsub = onSnapshot(q, (snap)=>{
      const list=[];
      snap.forEach(d=> list.push({uid:d.id, ...d.data()}));
      renderUsers(list, (u)=> u.vipTier ? `ğŸ‘‘ VIP ${u.vipTier} â€¢ ${u.vipName||""}` : "ThÆ°á»ng");
    });
  }

  // ===== BXH Cáº¶P ÄÃ”I (weddings) =====
  async function loadCouple(){
    // cÆ°á»›i thÃ¬ náº±m trong users.marriedTo
    const q = query(
      collection(db, "users"),
      where("marriedTo","!=", null),
      limit(50)
    );

    unsub = onSnapshot(q, async (snap)=>{
      const marriedUsers=[];
      snap.forEach(d=> marriedUsers.push({uid:d.id, ...d.data()}));

      // gom theo weddingId (trÃ¡nh láº·p 2 láº§n)
      const map = new Map();
      marriedUsers.forEach(u=>{
        if(u.weddingId) map.set(u.weddingId, u);
      });

      const couples=[];
      for(const [weddingId, u] of map.entries()){
        const otherUid = u.marriedTo;
        const otherSnap = await getDoc(doc(db,"users", otherUid));
        const other = otherSnap.exists() ? otherSnap.data() : {};

        couples.push({
          weddingId,
          a:{ uid:u.uid, ...u },
          b:{ uid:otherUid, ...other }
        });
      }

      renderCouples(couples.slice(0,20));
    });
  }

  // ===== Render user list =====
  function renderUsers(list, rightTextFn){
    if(list.length===0){
      content.innerHTML = `<div class="muted">ChÆ°a cÃ³ dá»¯ liá»‡u.</div>`;
      return;
    }

    content.innerHTML = list.map((u, idx)=>{
      const vipTier = u.vipTier||0;
      const vipColor = getVipColor(vipTier);
      return `
        <div class="row">
          <div class="rank">${idx+1}</div>
          <img class="avatar" src="${u.avatar||'default.png'}" />
          <div style="flex:1">
            <div class="name" style="color:${vipColor}">
              ${u.name||"ChÆ°a Ä‘áº·t tÃªn"}
              ${vipTier?`<span class="vip">ğŸ‘‘VIP${vipTier}</span>`:""}
            </div>
            <div class="sub">
              ${u.gender?`â€¢ ${u.gender} `:""} ${u.age?`â€¢ ${u.age} tuá»•i`:""}
              ${u.activePet?`<br>ğŸ¾ ${u.activePet.name} Lv.${u.activePet.level||1}`:""}
              ${u.activeHouse?`<br>ğŸ  ${u.activeHouse.name} Lv.${u.activeHouse.level||1}`:""}
            </div>
          </div>
          <div class="sub pink"><b>${rightTextFn(u)}</b></div>
        </div>
      `;
    }).join("");
  }

  // ===== Render couples =====
  function renderCouples(couples){
    if(couples.length===0){
      content.innerHTML = `<div class="muted">ChÆ°a cÃ³ cáº·p Ä‘Ã´i nÃ o káº¿t hÃ´n.</div>`;
      return;
    }

    content.innerHTML = couples.map((c, idx)=>{
      const a=c.a, b=c.b;
      return `
        <div class="row">
          <div class="rank">${idx+1}</div>

          <img class="avatar" src="${a.avatar||'default.png'}" />
          <div style="flex:1">
            <div class="name">${a.name||"A"}</div>
            <div class="sub muted">${a.uid}</div>
          </div>

          <div class="gold" style="font-size:20px;font-weight:900;">ğŸ’</div>

          <img class="avatar" src="${b.avatar||'default.png'}" />
          <div style="flex:1">
            <div class="name">${b.name||"B"}</div>
            <div class="sub muted">${b.uid}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  function getVipColor(tier){
    if(tier>=6) return "#ffd700";
    if(tier==5) return "#ff8ac9";
    if(tier==4) return "#b388ff";
    if(tier==3) return "#7bdff2";
    if(tier==2) return "#7ee081";
    if(tier==1) return "#ffffff";
    return "#fff";
  }
</script>

</body>
</html>
