<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Events</title>
<link rel="stylesheet" href="theme.css">
<style>
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}
  @media(max-width:700px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<div class="container">
  <h2>ðŸŽ‰ Sá»± kiá»‡n NearLove</h2>
  <div id="list" class="grid"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">ChÆ°a cÃ³ sá»± kiá»‡n.</p>
</div>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const listEl=document.getElementById("list");
  const emptyEl=document.getElementById("empty");

  onAuthStateChanged(auth,(user)=>{
    if(!user){location.href="login.html";return;}

    const q=query(collection(db,"events"), orderBy("startAt","desc"));
    onSnapshot(q,(snap)=>{
      listEl.innerHTML="";
      if(snap.empty){ emptyEl.style.display="block"; return; }
      emptyEl.style.display="none";

      snap.forEach(d=>{
        const e=d.data();
        const now=Date.now();
        const start=e.startAt?.toDate?e.startAt.toDate().getTime():0;
        const end=e.endAt?.toDate?e.endAt.toDate().getTime():0;

        const status = now<start ? "Sáº¯p diá»…n ra" : (now>end ? "ÄÃ£ káº¿t thÃºc" : "Äang diá»…n ra");
        const canJoin = now>=start && now<=end && e.isActive;

        const card=document.createElement("div");
        card.className="card fade-in";
        card.innerHTML=`
          <div style="font-size:34px">${e.icon||"ðŸŽ‰"}</div>
          <div style="font-weight:900;font-size:16px">${e.name}</div>
          <div class="muted">${e.desc||""}</div>
          <div class="tag">${status}</div>
          <div class="muted small">
            ${start?new Date(start).toLocaleString():""} â†’ ${end?new Date(end).toLocaleString():""}
          </div>
          <button class="btn ${canJoin?'':'light'}" style="margin-top:6px"
            ${canJoin?'':'disabled'}
            onclick="join('${d.id}')">
            VÃ o phÃ²ng event
          </button>
        `;
        listEl.appendChild(card);
      });
    });
  });

  window.join=(id)=>{
    location.href=`event_room.html?e=${id}`;
  };
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("events");
</script>

</body>
</html>
