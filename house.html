<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Nh√† c·ª≠a</title>

<style>
  body{
    font-family:Arial;background:#0f1115;color:white;
    padding:16px;padding-bottom:80px;
  }
  h2{text-align:center;color:#ffd1e6;margin:8px 0 14px;}
  .box{
    max-width:900px;margin:0 auto 12px;background:#151824;
    padding:14px;border-radius:14px;border:1px solid rgba(255,255,255,0.06);
  }
  .sub{font-size:14px;opacity:.85;line-height:1.5}
  .grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;
  }
  .card{
    background:rgba(255,255,255,0.06);
    padding:12px;border-radius:14px;cursor:pointer;
    border:1px solid transparent;display:flex;flex-direction:column;gap:6px;align-items:center;
    min-height:140px;
  }
  .card.active{
    border:1px solid #ff8ac9;background:rgba(255,61,127,0.18);
  }
  .icon{font-size:40px;}
  .name{font-weight:900;}
  .btn{
    width:100%;padding:12px;border:none;border-radius:12px;
    background:linear-gradient(135deg,#ff3d7f,#ff8ac9);color:white;font-weight:bold;
    font-size:16px;margin-top:10px;cursor:pointer;
  }
  .btn.light{background:rgba(255,255,255,0.1);}
  .status{
    margin-top:8px;background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;
    font-size:14px;
  }
  #msg{margin-top:8px;font-size:14px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:600px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<h2>üè† Nh√† c·ª≠a NearLove</h2>

<!-- Nh√† ƒëang ·ªü -->
<div class="box">
  <div class="sub">Nh√† ƒëang ·ªü:</div>
  <div class="status" id="activeHouseBox">ƒêang t·∫£i...</div>

  <button class="btn light" onclick="upgradeHouse()">üß± N√¢ng c·∫•p nh√† (t·ªën xu)</button>
  <p id="upMsg" style="margin-top:6px;"></p>
</div>

<!-- Danh s√°ch nh√† trong kho -->
<div class="box">
  <div class="sub">Ch·ªçn nh√† t·ª´ kho ƒë·ªì (mua ·ªü Shop ‚Üí Nh√† c·ª≠a):</div>
  <div class="grid" id="houseGrid"></div>
  <p id="msg"></p>
</div>

<!-- Firebase -->
<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins, getCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const gridEl = document.getElementById("houseGrid");
  const msgEl = document.getElementById("msg");
  const activeBox = document.getElementById("activeHouseBox");
  const upMsg = document.getElementById("upMsg");

  let myUid=null;
  let inventoryHouses=[];
  let activeHouse=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); location.href="login.html"; return; }
    myUid=user.uid;

    await ensureCoins();

    // load kho nh√†
    const invSnap = await getDoc(doc(db,"inventories",myUid));
    const items = invSnap.exists() ? (invSnap.data().items || []) : [];
    inventoryHouses = items.filter(i=> (i.type||"").toLowerCase().includes("nh√† c·ª≠a") || (i.id||"").includes("house"));

    // load active house t·ª´ profile
    const meSnap = await getDoc(doc(db,"users",myUid));
    const me = meSnap.exists()?meSnap.data():{};
    activeHouse = me.activeHouse || null;

    renderActiveHouse();
    renderHouseList();
  });

  function renderActiveHouse(){
    if(!activeHouse){
      activeBox.innerHTML="Ch∆∞a c√≥ nh√† n√†o. V√†o Shop mua nh√† tr∆∞·ªõc nh√© üè†";
      return;
    }
    activeBox.innerHTML = `
      <div style="font-size:26px">${activeHouse.icon || "üè†"}</div>
      <b>${activeHouse.name}</b><br>
      Level: <b>${activeHouse.level||1}</b>
    `;
  }

  function renderHouseList(){
    gridEl.innerHTML="";

    if(inventoryHouses.length===0){
      msgEl.innerHTML="B·∫°n ch∆∞a c√≥ nh√†. V√†o Shop mua nh√† tr∆∞·ªõc nh√© üè†";
      return;
    }
    msgEl.innerText="";

    inventoryHouses.forEach(h=>{
      const div=document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <div class="icon">${h.icon||"üè†"}</div>
        <div class="name">${h.name}</div>
        <div class="sub">${h.price||0} xu</div>
      `;

      if(activeHouse && activeHouse.id===h.id){
        div.classList.add("active");
      }

      div.onclick=()=>selectHouse(h);
      gridEl.appendChild(div);
    });
  }

  async function selectHouse(h){
    activeHouse = {
      id: h.id,
      name: h.name,
      icon: h.icon || "üè†",
      level: activeHouse?.id===h.id ? (activeHouse.level||1) : 1
    };

    await updateDoc(doc(db,"users",myUid),{
      activeHouse: activeHouse,
      houseUpdatedAt: serverTimestamp()
    });

    msgEl.style.color="lightgreen";
    msgEl.innerText=`‚úÖ B·∫°n ƒëang ·ªü: ${h.name}`;
    renderActiveHouse();
    renderHouseList();
  }

  // N√¢ng c·∫•p nh√† (t·ªën xu)
  window.upgradeHouse = async ()=>{
    if(!activeHouse){
      upMsg.style.color="red";
      upMsg.innerText="B·∫°n ch∆∞a ch·ªçn nh√† ƒë·ªÉ ·ªü.";
      return;
    }

    const curLevel = activeHouse.level || 1;
    const cost = curLevel * 300; // level c√†ng cao c√†ng t·ªën

    const res = await spendCoins(cost);
    if(!res.ok){
      upMsg.style.color="red";
      upMsg.innerText=`Kh√¥ng ƒë·ªß xu ƒë·ªÉ n√¢ng c·∫•p. C·∫ßn ${cost} xu.`;
      return;
    }

    activeHouse.level = curLevel + 1;

    await updateDoc(doc(db,"users",myUid),{
      activeHouse: activeHouse,
      houseUpdatedAt: serverTimestamp()
    });

    upMsg.style.color="lightgreen";
    upMsg.innerText=`üß± N√¢ng c·∫•p th√†nh c√¥ng! Nh√† l√™n Level ${activeHouse.level} (-${cost} xu)`;
    renderActiveHouse();
  };
</script>

</body>
</html>
