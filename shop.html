<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Shop</title>

<style>
  body{
    font-family:Arial;background:#0f1115;color:white;
    padding:16px;padding-bottom:80px;
  }
  h2{text-align:center;color:#ffd1e6;margin:8px 0 14px;}
  .bar{
    max-width:1000px;margin:0 auto 12px;
    background:rgba(255,255,255,0.06);padding:10px;border-radius:12px;
    display:flex;gap:8px;flex-wrap:wrap;font-weight:bold;
  }
  .pill{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;}
  .grid{
    max-width:1000px;margin:auto;
    display:grid;grid-template-columns:repeat(3,1fr);gap:10px;
  }
  .card{
    background:#151824;border-radius:14px;padding:12px;
    border:1px solid rgba(255,255,255,0.06);
    display:flex;flex-direction:column;gap:6px;min-height:170px;
  }
  .icon{font-size:34px;}
  .name{font-weight:900;font-size:17px;}
  .type{font-size:12px;opacity:.8;background:rgba(255,255,255,0.08);padding:2px 6px;border-radius:999px;width:fit-content;}
  .price{font-weight:900;color:#ff8ac9;}
  .btn{
    margin-top:auto;border:none;cursor:pointer;font-weight:bold;
    padding:10px;border-radius:10px;background:linear-gradient(135deg,#ff3d7f,#ff8ac9);
    color:white;font-size:15px;
  }
  .btn.light{background:rgba(255,255,255,0.12);}
  #msg{max-width:1000px;margin:10px auto 0;font-size:14px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:600px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<h2>üõí C·ª≠a h√†ng NearLove</h2>

<div class="bar">
  <div class="pill">Xu c·ªßa b·∫°n: <span id="coins">...</span> üí∞</div>
  <div class="pill">ƒê·ªì ƒë√£ mua: <span id="owned">0</span></div>
</div>

<div class="grid" id="shopGrid"></div>
<p id="msg"></p>

<!-- Firebase -->
<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { ensureCoins, spendCoins, getCoins } from "./coins.js";
  import {
    doc, getDoc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const items = [
    { id:"gift_rose", name:"Hoa h·ªìng", price:50,  icon:"üåπ", type:"Qu√† t·∫∑ng" },
    { id:"gift_teddy", name:"G·∫•u b√¥ng", price:120, icon:"üß∏", type:"Qu√† t·∫∑ng" },
    { id:"ring_silver", name:"Nh·∫´n b·∫°c", price:500, icon:"üíç", type:"Wedding" },
    { id:"ring_gold", name:"Nh·∫´n v√†ng", price:1200, icon:"üíç‚ú®", type:"Wedding" },
    { id:"car_small", name:"Xe ·∫£o mini", price:800, icon:"üöó", type:"Xe" },
    { id:"car_lux", name:"Si√™u xe ·∫£o", price:2500, icon:"üèéÔ∏è", type:"Xe" },
    { id:"pet_cat", name:"M√®o cute", price:600, icon:"üê±", type:"Th√∫ c∆∞ng" },
    { id:"pet_fox", name:"C√°o tuy·∫øt", price:1800, icon:"ü¶ä", type:"Th√∫ c∆∞ng" },
    { id:"house_room", name:"Ph√≤ng tr·ªç ·∫£o", price:1500, icon:"üè†", type:"Nh√† c·ª≠a" },
    { id:"house_villa", name:"Bi·ªát th·ª± ·∫£o", price:6000, icon:"üè∞", type:"Nh√† c·ª≠a" },
  ];

  const grid = document.getElementById("shopGrid");
  const msgEl = document.getElementById("msg");
  const coinsEl = document.getElementById("coins");
  const ownedEl = document.getElementById("owned");

  let uid = null;
  let inventory = [];

  function renderShop(){
    grid.innerHTML="";
    items.forEach(it=>{
      const owned = inventory.some(x=>x.id===it.id);

      const c=document.createElement("div");
      c.className="card";
      c.innerHTML=`
        <div class="icon">${it.icon}</div>
        <div class="name">${it.name}</div>
        <div class="type">${it.type}</div>
        <div class="price">${it.price} xu</div>
        <button class="btn ${owned?'light':''}">
          ${owned ? "ƒê√£ mua" : "Mua ngay"}
        </button>
      `;
      const btn=c.querySelector("button");
      btn.onclick=()=>buyItem(it, owned);
      grid.appendChild(c);
    });

    ownedEl.innerText = inventory.length;
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); location.href="login.html"; return; }
    uid=user.uid;

    // ƒë·∫£m b·∫£o c√≥ coins
    const c=await ensureCoins();
    coinsEl.innerText=c;

    // load kho ƒë·ªì
    const invSnap=await getDoc(doc(db,"inventories",uid));
    inventory = invSnap.exists() ? (invSnap.data().items || []) : [];
    renderShop();
  });

  async function buyItem(item, owned){
    if(owned){
      msgEl.style.color="#aaa";
      msgEl.innerText="B·∫°n ƒë√£ mua m√≥n n√†y r·ªìi.";
      return;
    }

    const res = await spendCoins(item.price);
    if(!res.ok){
      msgEl.style.color="red";
      msgEl.innerText="Kh√¥ng ƒë·ªß xu. H√£y ch∆°i game/ƒëi·ªÉm danh ƒë·ªÉ ki·∫øm th√™m nh√©!";
      return;
    }

    // c·∫≠p nh·∫≠t coins UI
    coinsEl.innerText = res.coins;

    // th√™m v√†o kho
    inventory.push({
      ...item,
      time: new Date().toISOString()
    });

    await setDoc(doc(db,"inventories",uid),{
      items: inventory,
      updatedAt: serverTimestamp()
    },{merge:true});

    msgEl.style.color="lightgreen";
    msgEl.innerText=`‚úÖ Mua th√†nh c√¥ng: ${item.name}`;
    renderShop();
  }
</script>

</body>
</html>
