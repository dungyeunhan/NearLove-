<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Match</title>
<link rel="stylesheet" href="theme.css">
</head>
<body>

<div class="container">
  <h2>ğŸ’— Danh sÃ¡ch Ä‘Ã£ match</h2>
  <div id="matchList" class="grid-2"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">ChÆ°a cÃ³ match nÃ o.</p>
</div>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, query, where, onSnapshot, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const matchList = document.getElementById("matchList");
  const emptyEl = document.getElementById("empty");
  let uid = null;

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");
      location.href = "login.html";
      return;
    }
    uid = user.uid;

    const q = query(
      collection(db, "matches"),
      where("users", "array-contains", uid)
    );

    onSnapshot(q, async (snap) => {
      matchList.innerHTML = "";

      if (snap.empty) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      // render tá»«ng match
      for (const m of snap.docs) {
        const data = m.data();
        const otherUid = data.users.find(u => u !== uid);
        const matchId = m.id; // Ä‘Ã£ lÆ°u theo id

        const otherSnap = await getDoc(doc(db, "users", otherUid));
        const other = otherSnap.exists() ? otherSnap.data() : {};

        const vipTier = other.vipTier || 0;
        const vipColor = getVipColor(vipTier);

        const petText = other.activePet
          ? `ğŸ¾ ${other.activePet.name} Lv.${other.activePet.level||1}`
          : "";
        const houseText = other.activeHouse
          ? `ğŸ  ${other.activeHouse.name} Lv.${other.activeHouse.level||1}`
          : "";

        const card = document.createElement("div");
        card.className = "card fade-in";

        card.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center;">
            <img class="avatar" src="${other.avatar || "default.png"}">
            <div style="flex:1;">
              <div style="font-weight:900;font-size:18px;color:${vipColor}">
                ${other.name || "ChÆ°a Ä‘áº·t tÃªn"} ${vipTier?`ğŸ‘‘VIP${vipTier}`:""}
              </div>
              <div class="muted">
                ${other.gender?`â€¢ ${other.gender}`:""} ${other.age?`â€¢ ${other.age} tuá»•i`:""}
                ${petText?`<br>${petText}`:""}
                ${houseText?`<br>${houseText}`:""}
              </div>
            </div>
          </div>

          <button class="btn blue" style="margin-top:12px"
            onclick="location.href='chat.html?match=${matchId}'">
            ğŸ’¬ Chat ngay
          </button>
        `;

        matchList.appendChild(card);
      }
    });
  });

  function getVipColor(tier){
    if(tier>=6) return "#ffd700";
    if(tier==5) return "#ff8ac9";
    if(tier==4) return "#b388ff";
    if(tier==3) return "#7bdff2";
    if(tier==2) return "#7ee081";
    if(tier==1) return "#ffffff";
    return "#ffffff";
  }
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("match");
</script>

</body>
</html>
