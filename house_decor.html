<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Trang trÃ­ nhÃ </title>
<link rel="stylesheet" href="theme.css">
<style>
  #room{
    position:relative;height:360px;border-radius:16px;
    background:linear-gradient(180deg,#2a2f45,#141827);
    border:1px solid rgba(255,255,255,0.08);
    overflow:hidden;
  }
  .item{
    position:absolute;font-size:34px;cursor:grab;user-select:none;
    transform:translate(-50%,-50%);
  }
  .shop-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  @media(max-width:700px){.shop-grid{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ  Trang trÃ­ nhÃ </h2>

  <div class="box">
    <div id="houseInfo" class="muted">Äang táº£i...</div>
    <div id="room" style="margin-top:10px;"></div>
    <button class="btn light" style="margin-top:10px" onclick="saveDecor()">ğŸ’¾ LÆ°u bá»‘ cá»¥c</button>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;margin-bottom:8px;">Shop dÃ©cor (mua báº±ng xu)</div>
    <div id="shop" class="shop-grid"></div>
    <p id="msg" class="muted"></p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const room = document.getElementById("room");
  const shopEl = document.getElementById("shop");
  const msgEl = document.getElementById("msg");
  const houseInfo = document.getElementById("houseInfo");

  let uid=null;
  let decor=[]; // {itemId,name,icon,x,y}
  let dragging=null;

  // dÃ©cor items MVP
  const DECOR_SHOP = [
    {id:"sofa1", name:"Sofa há»“ng", icon:"ğŸ›‹ï¸", cost:120},
    {id:"plant1", name:"CÃ¢y cáº£nh", icon:"ğŸª´", cost:80},
    {id:"lamp1", name:"ÄÃ¨n ngá»§", icon:"ğŸ’¡", cost:60},
    {id:"tv1", name:"TV lá»›n", icon:"ğŸ“º", cost:150},
    {id:"bear1", name:"Gáº¥u bÃ´ng", icon:"ğŸ§¸", cost:50},
    {id:"music1", name:"Loa EDM", icon:"ğŸ§", cost:100},
  ];

  onAuthStateChanged(auth, async (user)=>{
    if(!user){alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");location.href="login.html";return;}
    uid=user.uid;
    await ensureCoins();

    // load house + decor
    const hRef = doc(db,"houses",uid);
    const hSnap = await getDoc(hRef);
    const h = hSnap.exists()?hSnap.data():{};
    const active = h.activeHouse || {name:"NhÃ  nhá»",level:1,icon:"ğŸ "};
    decor = h.decor || [];

    houseInfo.innerHTML = `NhÃ  hiá»‡n táº¡i: <b>${active.icon} ${active.name}</b> â€¢ Lv.${active.level||1}`;

    renderRoom();
    renderShop();
  });

  function renderRoom(){
    room.innerHTML="";
    decor.forEach((it, idx)=>{
      const d=document.createElement("div");
      d.className="item";
      d.innerText=it.icon;
      d.style.left=it.x+"px";
      d.style.top=it.y+"px";
      d.dataset.idx=idx;

      d.addEventListener("pointerdown",(e)=>{
        dragging=idx;
        d.setPointerCapture(e.pointerId);
      });
      d.addEventListener("pointermove",(e)=>{
        if(dragging!==idx) return;
        const rect=room.getBoundingClientRect();
        const x=e.clientX-rect.left;
        const y=e.clientY-rect.top;
        decor[idx].x=clamp(x,20,rect.width-20);
        decor[idx].y=clamp(y,20,rect.height-20);
        d.style.left=decor[idx].x+"px";
        d.style.top=decor[idx].y+"px";
      });
      d.addEventListener("pointerup",()=> dragging=null);

      // long press remove (MVP)
      d.addEventListener("dblclick",()=>{
        if(confirm("Gá»¡ váº­t pháº©m nÃ y khá»i nhÃ ?")){
          decor.splice(idx,1);
          renderRoom();
        }
      });

      room.appendChild(d);
    });
  }

  function renderShop(){
    shopEl.innerHTML="";
    DECOR_SHOP.forEach(it=>{
      const card=document.createElement("div");
      card.className="card fade-in";
      card.innerHTML=`
        <div style="font-size:32px;text-align:center">${it.icon}</div>
        <div style="font-weight:900;text-align:center">${it.name}</div>
        <div class="muted" style="text-align:center">GiÃ¡: ${it.cost} xu</div>
        <button class="btn" style="margin-top:6px" onclick="buyDecor('${it.id}')">Mua & Ä‘áº·t</button>
      `;
      shopEl.appendChild(card);
    });
  }

  window.buyDecor = async (itemId)=>{
    const it=DECOR_SHOP.find(x=>x.id===itemId);
    if(!it) return;

    const res=await spendCoins(it.cost);
    if(!res.ok){ alert("KhÃ´ng Ä‘á»§ xu!"); return; }

    // auto place center
    const rect=room.getBoundingClientRect();
    decor.push({
      itemId: it.id, name: it.name, icon: it.icon,
      x: rect.width/2, y: rect.height/2
    });
    renderRoom();

    msgEl.style.color="lightgreen";
    msgEl.innerText=`âœ… ÄÃ£ mua ${it.name} vÃ  Ä‘áº·t vÃ o nhÃ .`;
  };

  window.saveDecor = async ()=>{
    if(!uid) return;
    await setDoc(doc(db,"houses",uid),{
      decor,
      updatedAt: serverTimestamp()
    },{merge:true});

    msgEl.style.color="lightgreen";
    msgEl.innerText="ğŸ’¾ ÄÃ£ lÆ°u bá»‘ cá»¥c nhÃ !";
  };

  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("house");
</script>

</body>
</html>
