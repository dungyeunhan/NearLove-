<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - PhÃ²ng VIP</title>
<link rel="stylesheet" href="theme.css">
<style>
  body{padding:0;padding-bottom:74px;}
  header{position:sticky;top:0;background:#121625;padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);}
  #messages{height:calc(100vh - 140px);overflow-y:auto;padding:12px;}
  footer{position:fixed;left:0;right:0;bottom:74px;background:#121625;padding:8px;display:flex;gap:8px;}
  footer input{margin:0;border-radius:999px;}
</style>
</head>
<body>

<header>
  <div style="font-weight:900">ðŸ‘‘ PhÃ²ng VIP</div>
  <div class="muted" id="roomInfo"></div>
</header>

<div id="messages"></div>

<footer>
  <input id="text" placeholder="Nháº­p tin nháº¯n VIP...">
  <button class="btn" onclick="sendMsg()">Gá»­i</button>
</footer>

<script type="module" src="firebase.js"></script>
<script type="module" src="vip.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { getMyVip } from "./vip.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, collection, addDoc,
    query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const msgBox=document.getElementById("messages");
  const textEl=document.getElementById("text");
  const roomInfo=document.getElementById("roomInfo");

  let uid=null, me=null, vip=null, tier=0;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){location.href="login.html";return;}
    uid=user.uid;

    const meSnap=await getDoc(doc(db,"users",uid));
    me=meSnap.data()||{};
    vip=await getMyVip();
    tier=me.vipTier||0;

    if(tier<=0){
      alert("Báº¡n chÆ°a cÃ³ VIP."); location.href="vip.html"; return;
    }

    roomInfo.innerText=`Tier ${tier} â€” ${vip.name}`;

    const q=query(
      collection(db,"vipRooms",String(tier),"messages"),
      orderBy("time","asc")
    );

    onSnapshot(q,(snap)=>{
      msgBox.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const b=document.createElement("div");
        b.className="row fade-in";
        b.innerHTML=`
          <img class="avatar" src="${m.fromAvatar||'default.png'}" style="width:36px;height:36px;">
          <div style="flex:1">
            <b style="color:${m.fromVipColor||'#ddd'}">
              ${m.fromName}
              <span class="tag" style="background:${m.fromVipColor||'#ddd'};color:#111;margin-left:4px;">
                ${m.fromVipName||""}
              </span>
            </b>
            <div>${escapeHtml(m.text||"")}</div>
          </div>
        `;
        msgBox.appendChild(b);
      });
      msgBox.scrollTop=msgBox.scrollHeight;
    });
  });

  window.sendMsg = async ()=>{
    const t=textEl.value.trim();
    if(!t) return;

    await addDoc(collection(db,"vipRooms",String(tier),"messages"),{
      fromUid: uid,
      fromName: me.name||uid,
      fromAvatar: me.avatar||"default.png",
      fromVipColor: me.vipColor||"#999",
      fromVipName: me.vipName||"",
      text: t,
      time: serverTimestamp()
    });
    textEl.value="";
  };

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("vip");
</script>

</body>
</html>
