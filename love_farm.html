<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Love Farm</title>
<link rel="stylesheet" href="theme.css">
<style>
  .plot{display:flex;align-items:center;justify-content:space-between;}
</style>
</head>
<body>

<div class="container">
  <h2>üåæ Love Farm</h2>

  <div class="box">
    <div class="muted">Tr·ªìng c√¢y 5 ph√∫t ‚Üí thu ho·∫°ch xu.</div>
    <button class="btn" onclick="plant()">üå± Tr·ªìng c√¢y m·ªõi</button>
    <p id="msg" class="muted"></p>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Ru·ªông c·ªßa b·∫°n</div>
    <div id="plots" style="margin-top:8px;"></div>
    <p id="empty" class="muted" style="display:none;">Ch∆∞a c√≥ c√¢y n√†o.</p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, addCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, setDoc, updateDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const plotsEl=document.getElementById("plots");
  const emptyEl=document.getElementById("empty");
  const msg=document.getElementById("msg");

  let uid=null, farm=null;

  const CROPS=[
    {id:"rose", name:"Hoa h·ªìng", icon:"üåπ", time:5*60*1000, reward:40},
    {id:"cake", name:"B√°nh ng·ªçt", icon:"üç∞", time:5*60*1000, reward:50},
    {id:"gem",  name:"H·∫°t pha l√™", icon:"üíé", time:5*60*1000, reward:70},
  ];

  onAuthStateChanged(auth, async (user)=>{
    if(!user){alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");location.href="login.html";return;}
    uid=user.uid;
    await ensureCoins();

    await loadFarm();
    renderFarm();

    setInterval(async ()=>{
      await loadFarm();
      renderFarm();
    },1000);
  });

  async function loadFarm(){
    const fRef=doc(db,"farms",uid);
    const fSnap=await getDoc(fRef);
    farm = fSnap.exists()?fSnap.data():{crops:[]};
  }

  window.plant = async ()=>{
    const crop=CROPS[Math.floor(Math.random()*CROPS.length)];
    const now=Date.now();
    const planted={
      cropId: crop.id,
      name: crop.name,
      icon: crop.icon,
      plantedAt: now,
      readyAt: now + crop.time,
      reward: crop.reward,
      status:"growing"
    };

    farm.crops = farm.crops || [];
    farm.crops.push(planted);

    await setDoc(doc(db,"farms",uid),farm,{merge:true});
    msg.style.color="lightgreen";
    msg.innerText=`üå± ƒê√£ tr·ªìng ${crop.icon} ${crop.name}. 5 ph√∫t sau thu ho·∫°ch!`;
    renderFarm();
  };

  async function harvest(idx){
    const c=farm.crops[idx];
    if(!c || c.status!=="ready") return;

    await addCoins(c.reward);
    farm.crops.splice(idx,1);
    await setDoc(doc(db,"farms",uid),farm,{merge:true});

    alert(`üéâ Thu ho·∫°ch ${c.icon} +${c.reward} xu!`);
    renderFarm();
  }

  function renderFarm(){
    plotsEl.innerHTML="";
    const crops=farm.crops||[];
    if(crops.length===0){ emptyEl.style.display="block"; return; }
    emptyEl.style.display="none";

    const now=Date.now();
    crops.forEach((c,idx)=>{
      const left=Math.max(0, c.readyAt-now);
      const ready=left===0;

      if(ready) c.status="ready";

      const row=document.createElement("div");
      row.className="row plot fade-in";
      row.innerHTML=`
        <div>
          <div style="font-weight:900">${c.icon} ${c.name}</div>
          <div class="muted">${ready?`S·∫µn s√†ng thu ho·∫°ch!`:`C√≤n ${Math.ceil(left/1000)}s`}</div>
        </div>
        <button class="btn ${ready?'':'light'}" style="width:auto;min-width:120px"
          ${ready?'':'disabled'}>
          Thu ho·∫°ch +${c.reward}
        </button>
      `;
      row.querySelector("button").onclick=()=>harvest(idx);
      plotsEl.appendChild(row);
    });
  }
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("event");
</script>

</body>
</html>
