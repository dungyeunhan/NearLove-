<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Chat</title>
<link rel="stylesheet" href="theme.css">
<style>
  body{padding:0;padding-bottom:74px;}
  header{
    position:sticky;top:0;z-index:10;
    background:#121625;border-bottom:1px solid rgba(255,255,255,0.08);
    padding:10px 12px;display:flex;align-items:center;gap:10px;
  }
  #messages{
    height:calc(100vh - 140px);
    overflow-y:auto;padding:12px;background:transparent;
  }
  .bubble{
    max-width:75%;padding:10px 12px;border-radius:14px;margin:6px 0;
    display:flex;flex-direction:column;gap:4px;font-size:15px;
  }
  .me{
    margin-left:auto;background:linear-gradient(135deg,#ff3d7f,#ff8ac9);
  }
  .other{
    margin-right:auto;background:#151824;border:1px solid rgba(255,255,255,0.08);
  }
  .time{font-size:11px;opacity:.8;}
  footer{
    position:fixed;left:0;right:0;bottom:74px;
    background:#121625;border-top:1px solid rgba(255,255,255,0.08);
    padding:8px;display:flex;gap:8px;
  }
  footer input{
    margin:0;border-radius:999px;
  }
  footer button{width:auto;border-radius:999px;padding:10px 16px;}
</style>
</head>
<body>

<header>
  <img id="otherAvatar" class="avatar" style="width:44px;height:44px;">
  <div style="flex:1">
    <div id="otherName" style="font-weight:900;font-size:16px;">...</div>
    <div id="otherMeta" class="muted" style="font-size:12px;"></div>
  </div>
  <a href="match.html" class="tag">‚Üê Match</a>
</header>

<div id="messages"></div>

<footer>
  <input id="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
  <button class="btn" onclick="sendMessage()">G·ª≠i</button>
</footer>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
import { auth, db } from "./firebase.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import {
  doc, collection, addDoc, orderBy, query, onSnapshot,
  serverTimestamp, getDoc
} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const matchId = params.get("match");
if(!matchId){ alert("Thi·∫øu matchId!"); location.href="match.html"; }

const messagesDiv = document.getElementById("messages");
const msgRef = collection(db, "chats", matchId, "messages");

let currentUid=null, otherUid=null, otherProfile=null;

// l·∫•y uid ƒë·ªëi ph∆∞∆°ng t·ª´ match
async function loadOtherFromMatch(myUid){
  const mSnap = await getDoc(doc(db,"matches", matchId));
  if(!mSnap.exists()){
    alert("Match kh√¥ng t·ªìn t·∫°i!");
    location.href="match.html";
    return;
  }
  const users = mSnap.data().users || [];
  otherUid = users.find(u=>u!==myUid);

  const oSnap = await getDoc(doc(db,"users", otherUid));
  otherProfile = oSnap.exists()?oSnap.data():{};

  // render header
  document.getElementById("otherAvatar").src = otherProfile.avatar || "default.png";
  document.getElementById("otherName").innerText =
    `${otherProfile.name || "Ng∆∞·ªùi ·∫•y"} ${otherProfile.vipTier?`üëëVIP${otherProfile.vipTier}`:""}`;
  document.getElementById("otherMeta").innerText =
    `${otherProfile.gender||""} ${otherProfile.age?`‚Ä¢ ${otherProfile.age} tu·ªïi`:""}`;
}

onAuthStateChanged(auth, async (user)=>{
  if(!user){ alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); location.href="login.html"; return; }
  currentUid = user.uid;
  await loadOtherFromMatch(currentUid);

  const q = query(msgRef, orderBy("time","asc"));
  onSnapshot(q, (snap)=>{
    messagesDiv.innerHTML="";
    snap.forEach(d=>{
      const data=d.data();
      const div=document.createElement("div");
      div.className="bubble "+(data.from===currentUid?"me":"other");

      const timeStr = data.time?.toDate
        ? data.time.toDate().toLocaleString()
        : "";

      div.innerHTML = `
        <div>${escapeHtml(data.text||"")}</div>
        <div class="time">${timeStr}</div>
      `;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
});

window.sendMessage = async ()=>{
  const textEl=document.getElementById("text");
  const t=textEl.value.trim();
  if(!t) return;

  await addDoc(msgRef,{
    from: currentUid,
    to: otherUid,
    text: t,
    time: serverTimestamp()
  });

  // update lastMessage cho inbox
  await addDoc(collection(db,"chats", matchId, "meta"),{
    lastText: t, lastTime: serverTimestamp()
  }).catch(()=>{});

  textEl.value="";
};

function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("match");
</script>

</body>
</html>
