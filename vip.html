<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - VIP</title>
<link rel="stylesheet" href="theme.css">
<style>
  .vip-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  @media(max-width:700px){.vip-grid{grid-template-columns:repeat(2,1fr);}}
  .tier{border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:10px;}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ‘‘ NearLove VIP</h2>

  <div class="box" id="myVipBox">Äang táº£i...</div>

  <div class="vip-grid" id="tiers" style="margin-top:10px;"></div>
  <p id="msg" class="muted"></p>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script type="module" src="vip.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import { VIP_TIERS, buyVip, getMyVip } from "./vip.js";

  const myVipBox=document.getElementById("myVipBox");
  const tiersEl=document.getElementById("tiers");
  const msgEl=document.getElementById("msg");

  let uid=null, me=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){location.href="login.html";return;}
    uid=user.uid;

    const meSnap=await getDoc(doc(db,"users",uid));
    me=meSnap.exists()?meSnap.data():{};
    renderMyVip();

    renderTiers();
  });

  async function renderMyVip(){
    const vip=await getMyVip();
    const exp=me.vipExpireAt?.toDate?me.vipExpireAt.toDate().toLocaleString():"â€”";

    myVipBox.innerHTML=`
      <div style="font-weight:900;font-size:18px;color:${vip.color}">
        ${vip.name}
      </div>
      <div class="muted">Háº¿t háº¡n: <b>${exp}</b></div>
      <div class="muted">Tier hiá»‡n táº¡i: <b>${me.vipTier||0}</b></div>
    `;
  }

  function renderTiers(){
    tiersEl.innerHTML="";
    Object.entries(VIP_TIERS).forEach(([k,t])=>{
      const tier=Number(k);
      if(tier===0) return;

      const card=document.createElement("div");
      card.className="tier card fade-in";
      card.innerHTML=`
        <div style="font-weight:900;font-size:16px;color:${t.color}">
          ğŸ‘‘ ${t.name}
        </div>
        <div class="muted">GiÃ¡: <b>${t.price}</b> xu / 30 ngÃ y</div>

        <ul class="muted" style="margin-top:6px;font-size:12px;">
          <li>MÃ u chat riÃªng</li>
          <li>TÄƒng tá»‘c match</li>
          <li>PhÃ²ng VIP tier ${tier}</li>
          <li>Æ¯u tiÃªn BXH</li>
        </ul>

        <button class="btn" style="margin-top:8px" onclick="buy(${tier})">
          Mua / Gia háº¡n
        </button>
      `;
      tiersEl.appendChild(card);
    });
  }

  window.buy = async (tier)=>{
    msgEl.innerText="Äang xá»­ lÃ½...";
    const res=await buyVip(tier);
    if(!res.ok){
      msgEl.style.color="red";
      msgEl.innerText = res.msg==="not enough coins"
        ? "KhÃ´ng Ä‘á»§ xu Ä‘á»ƒ mua VIP."
        : "Lá»—i mua VIP.";
      return;
    }
    msgEl.style.color="lightgreen";
    msgEl.innerText=`âœ… Mua VIP thÃ nh cÃ´ng! Tier má»›i: ${res.newTier}`;
    location.reload();
  };
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("vip");
</script>

</body>
</html>
