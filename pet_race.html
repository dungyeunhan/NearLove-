<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - Pet Race</title>
<link rel="stylesheet" href="theme.css">
<style>
  .lane{background:#151824;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:8px;margin-top:8px;}
  .runner{font-size:30px;transition:transform .15s linear;}
  .track{height:34px;position:relative;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;}
  .runner{position:absolute;left:0;top:0;}
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ¾ Pet Race</h2>

  <div class="box" id="petInfo">Äang táº£i...</div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">ÄÆ°á»ng Ä‘ua</div>

    <div class="lane">
      Báº¡n: <b id="meName">Me</b>
      <div class="track"><div id="meRun" class="runner">ğŸ¾</div></div>
    </div>
    <div class="lane">
      Äá»‘i thá»§: <b id="botName">Bot</b>
      <div class="track"><div id="botRun" class="runner">ğŸ¾</div></div>
    </div>

    <button class="btn" id="startBtn" onclick="startRace()">ğŸ Äua ngay</button>
    <p id="msg" class="muted"></p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, addCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import { doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const petInfo=document.getElementById("petInfo");
  const meRun=document.getElementById("meRun");
  const botRun=document.getElementById("botRun");
  const msg=document.getElementById("msg");
  const startBtn=document.getElementById("startBtn");

  let uid=null, me=null, pet=null, racing=false;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!");location.href="login.html";return;}
    uid=user.uid;
    await ensureCoins();

    const meSnap=await getDoc(doc(db,"users",uid));
    me=meSnap.exists()?meSnap.data():{};
    pet=me.activePet;

    if(!pet){
      petInfo.innerHTML="Báº¡n chÆ°a cÃ³ pet. VÃ o Pet Ä‘á»ƒ nháº­n pet nhÃ©.";
      startBtn.disabled=true;
      return;
    }

    petInfo.innerHTML=`
      Pet cá»§a báº¡n: <b>${pet.icon||"ğŸ¾"} ${pet.name}</b> â€¢ Lv.${pet.level||1} â€¢ EXP ${pet.exp||0}
      <div class="muted">Äua tháº¯ng nháº­n xu + exp pet.</div>
    `;
    meRun.innerText=pet.icon||"ğŸ¾";
  });

  window.startRace = async ()=>{
    if(racing) return;
    racing=true; startBtn.disabled=true;
    msg.innerText="Äang Ä‘ua...";

    let mePos=0, botPos=0;
    const finish=260; // px
    const meSpeedBase= 2.2 + (pet.level||1)*0.15;
    const botSpeedBase= 2.1 + Math.random()*0.4;

    const timer=setInterval(async ()=>{
      mePos += meSpeedBase + Math.random()*1.2;
      botPos += botSpeedBase + Math.random()*1.2;

      meRun.style.transform=`translateX(${mePos}px)`;
      botRun.style.transform=`translateX(${botPos}px)`;

      if(mePos>=finish || botPos>=finish){
        clearInterval(timer);
        const win = mePos>=finish && mePos>=botPos;

        if(win){
          const reward = 30 + (pet.level||1)*5;
          const expGain = 15;

          await addCoins(reward);
          await updateDoc(doc(db,"users",uid),{
            "activePet.exp": increment(expGain)
          });

          msg.style.color="lightgreen";
          msg.innerText=`ğŸ‰ Báº¡n tháº¯ng! +${reward} xu, pet +${expGain} EXP`;
        }else{
          msg.style.color="#ffd1e6";
          msg.innerText="ğŸ˜¿ Báº¡n thua! Luyá»‡n pet rá»“i Ä‘ua láº¡i nhÃ©.";
        }

        // reset
        setTimeout(()=>{
          meRun.style.transform="translateX(0px)";
          botRun.style.transform="translateX(0px)";
          startBtn.disabled=false;
          racing=false;
        },900);
      }
    },120);
  };
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("pet");
</script>

</body>
</html>
