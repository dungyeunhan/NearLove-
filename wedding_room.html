<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>NearLove - PhÃ²ng cÆ°á»›i</title>
<link rel="stylesheet" href="theme.css">
<style>
  body{padding:0;padding-bottom:74px;}
  header{
    position:sticky;top:0;z-index:10;
    background:#121625;border-bottom:1px solid rgba(255,255,255,0.08);
    padding:10px 12px;display:flex;align-items:center;gap:10px;
  }
  .couple{
    display:flex;gap:12px;align-items:center;justify-content:center;margin-top:8px;
  }
  .gift-row{display:flex;gap:8px;flex-wrap:wrap;}
  .gift-btn{width:auto;min-width:110px;}
  #giftList{margin-top:8px;}
</style>
</head>
<body>

<header>
  <div style="font-size:22px;">ğŸ’</div>
  <div style="flex:1">
    <div id="title" style="font-weight:900;font-size:16px;">PhÃ²ng cÆ°á»›i</div>
    <div class="muted" id="sub" style="font-size:12px;"></div>
  </div>
  <a href="wedding.html" class="tag">â† HÃ´n lá»…</a>
</header>

<div class="container">

  <div class="box fade-in">
    <div class="couple" id="coupleBox">Äang táº£i...</div>
    <div class="muted" style="text-align:center;margin-top:8px;">
      Tá»•ng quÃ : <b id="totalGift">0</b> xu ğŸ
    </div>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;margin-bottom:6px;">ğŸ Táº·ng quÃ  cÆ°á»›i</div>
    <div class="gift-row">
      <button class="btn gift-btn" onclick="sendGift(20)">ğŸŒ¹ 20 xu</button>
      <button class="btn gift-btn" onclick="sendGift(50)">ğŸ« 50 xu</button>
      <button class="btn gift-btn" onclick="sendGift(100)">ğŸ’ 100 xu</button>
      <button class="btn gift-btn" onclick="sendGift(200)">ğŸ’ 200 xu</button>
      <button class="btn light gift-btn" onclick="customGift()">ğŸ’ Tuá»³ chá»n</button>
    </div>
  </div>

  <div class="box" style="margin-top:10px;">
    <div style="font-weight:900;">Danh sÃ¡ch quÃ  cÆ°á»›i</div>
    <div id="giftList"></div>
    <p id="emptyGift" class="muted" style="display:none;">ChÆ°a cÃ³ quÃ  nÃ o.</p>
  </div>
</div>

<script type="module" src="firebase.js"></script>
<script type="module" src="coins.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { ensureCoins, spendCoins } from "./coins.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, updateDoc, increment,
    collection, addDoc, query, orderBy, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const titleEl=document.getElementById("title");
  const subEl=document.getElementById("sub");
  const coupleBox=document.getElementById("coupleBox");
  const totalGiftEl=document.getElementById("totalGift");
  const giftList=document.getElementById("giftList");
  const emptyGift=document.getElementById("emptyGift");

  const params=new URLSearchParams(location.search);
  const weddingId=params.get("w");
  if(!weddingId){ alert("Thiáº¿u weddingId"); location.href="wedding.html"; }

  let uid=null, me=null, wedding=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p!"); location.href="login.html"; return; }
    uid=user.uid;
    await ensureCoins();

    const meSnap=await getDoc(doc(db,"users",uid));
    me=meSnap.exists()?meSnap.data():{};

    const wSnap=await getDoc(doc(db,"weddings",weddingId));
    if(!wSnap.exists()){
      alert("Wedding khÃ´ng tá»“n táº¡i."); location.href="wedding.html"; return;
    }
    wedding=wSnap.data();
    renderWedding();

    // realtime gifts list
    const q=query(
      collection(db,"weddingGifts",weddingId,"items"),
      orderBy("time","desc")
    );
    onSnapshot(q,(snap)=>{
      giftList.innerHTML="";
      if(snap.empty){ emptyGift.style.display="block"; return; }
      emptyGift.style.display="none";

      snap.forEach(d=>{
        const g=d.data();
        const timeStr=g.time?.toDate?g.time.toDate().toLocaleString():"";
        const row=document.createElement("div");
        row.className="row fade-in";
        row.innerHTML=`
          <img class="avatar" src="${g.fromAvatar||'default.png'}" style="width:40px;height:40px;">
          <div style="flex:1">
            <div style="font-weight:900">${g.fromName||"Ai Ä‘Ã³"} ğŸ ${g.amount} xu</div>
            <div class="muted">${g.message||""}</div>
          </div>
          <div class="muted" style="font-size:11px;">${timeStr}</div>
        `;
        giftList.appendChild(row);
      });
    });

    // realtime tá»•ng quÃ 
    onSnapshot(doc(db,"weddings",weddingId),(ds)=>{
      if(ds.exists()){
        wedding=ds.data();
        totalGiftEl.innerText=wedding.giftsTotal||0;
      }
    });
  });

  function renderWedding(){
    titleEl.innerText=`ğŸ’ HÃ´n lá»… cá»§a ${wedding.aName} & ${wedding.bName}`;
    subEl.innerText=`WeddingID: ${weddingId}`;

    coupleBox.innerHTML=`
      <div style="text-align:center">
        <img class="avatar" src="${wedding.aAvatar||'default.png'}">
        <div style="font-weight:900;margin-top:4px">${wedding.aName}</div>
      </div>
      <div style="font-size:26px;font-weight:900;">ğŸ’</div>
      <div style="text-align:center">
        <img class="avatar" src="${wedding.bAvatar||'default.png'}">
        <div style="font-weight:900;margin-top:4px">${wedding.bName}</div>
      </div>
    `;
    totalGiftEl.innerText=wedding.giftsTotal||0;
  }

  window.sendGift = async (amount)=>{
    if(amount<=0) return;

    const res = await spendCoins(amount);
    if(!res.ok){ alert("KhÃ´ng Ä‘á»§ xu Ä‘á»ƒ táº·ng."); return; }

    const msg = prompt("Lá»i chÃºc (tuá»³ chá»n):") || "";

    await addDoc(collection(db,"weddingGifts",weddingId,"items"),{
      fromUid: uid,
      fromName: me.name||"KhÃ¡ch má»i",
      fromAvatar: me.avatar||"default.png",
      amount,
      message: msg,
      time: serverTimestamp()
    });

    await updateDoc(doc(db,"weddings",weddingId),{
      giftsTotal: increment(amount)
    });

    alert("ğŸ‰ Táº·ng quÃ  thÃ nh cÃ´ng!");
  };

  window.customGift = ()=>{
    const x = Number(prompt("Nháº­p sá»‘ xu muá»‘n táº·ng:")||0);
    if(x>0) sendGift(x);
  };
</script>

<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("home");
</script>

</body>
</html>
