<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Th√†nh t√≠ch</title>

<style>
  body{
    font-family:Arial;background:#0f1115;color:white;
    padding:16px;padding-bottom:80px;
  }
  h2{text-align:center;color:#ffd1e6;margin:8px 0 14px;}
  .bar{
    max-width:900px;margin:0 auto 12px;
    background:#151824;padding:12px;border-radius:14px;
    border:1px solid rgba(255,255,255,0.06);
    display:flex;gap:8px;flex-wrap:wrap;font-weight:bold;
  }
  .pill{
    background:rgba(255,255,255,0.08);padding:6px 10px;border-radius:999px;
  }
  .grid{
    max-width:900px;margin:auto;
    display:grid;grid-template-columns:repeat(2,1fr);gap:10px;
  }
  .card{
    background:#151824;border-radius:14px;padding:12px;
    border:1px solid rgba(255,255,255,0.06);
    display:flex;gap:10px;align-items:flex-start;
  }
  .icon{
    width:50px;height:50px;border-radius:12px;
    display:grid;place-items:center;font-size:24px;font-weight:900;
    background:rgba(255,255,255,0.08);
  }
  .name{font-weight:900;font-size:16px;}
  .desc{font-size:13px;opacity:.9;line-height:1.4;margin-top:2px;}
  .meta{font-size:12px;opacity:.7;margin-top:4px;}
  .locked{
    opacity:.45; filter:grayscale(1);
  }
  .tag{
    display:inline-block;margin-top:6px;font-size:12px;font-weight:900;
    padding:3px 8px;border-radius:999px;background:rgba(255,255,255,0.08);
  }
  .unlocked .tag{background:rgba(0,255,140,0.15); color:#9dffcd;}
  .locked .tag{background:rgba(255,255,255,0.06);}
  #msg{max-width:900px;margin:10px auto 0;font-size:14px}
  @media (max-width:700px){.grid{grid-template-columns:1fr;}}
</style>
</head>
<body>

<h2>üèÖ Th√†nh t√≠ch NearLove</h2>

<div class="bar">
  <div class="pill">Xu: <span id="coins">...</span> üí∞</div>
  <div class="pill">VIP: <span id="vipNow">...</span></div>
  <div class="pill">Match: <span id="matchCount">...</span></div>
  <div class="pill">ƒê√£ c∆∞·ªõi: <span id="married">...</span></div>
  <div class="pill">Pet: <span id="petNow">...</span></div>
  <div class="pill">Nh√†: <span id="houseNow">...</span></div>
</div>

<div class="grid" id="achGrid"></div>
<p id="msg"></p>

<!-- Firebase -->
<script type="module" src="firebase.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    doc, getDoc, setDoc, updateDoc, serverTimestamp,
    collection, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const achGrid = document.getElementById("achGrid");
  const msgEl = document.getElementById("msg");

  const coinsEl = document.getElementById("coins");
  const vipNowEl = document.getElementById("vipNow");
  const matchCountEl = document.getElementById("matchCount");
  const marriedEl = document.getElementById("married");
  const petNowEl = document.getElementById("petNow");
  const houseNowEl = document.getElementById("houseNow");

  // ==== DANH S√ÅCH TH√ÄNH T√çCH (MVP) ====
  const ACHS = [
    { id:"first_login", icon:"üîê", name:"B∆∞·ªõc ch√¢n ƒë·∫ßu ti√™n", 
      desc:"ƒêƒÉng nh·∫≠p NearLove l·∫ßn ƒë·∫ßu.", 
      check:(u, s)=> true }, // ch·ªâ c·∫ßn c√≥ user l√† unlock

    { id:"profile_done", icon:"üë§", name:"H·ªì s∆° ho√†n ch·ªânh", 
      desc:"ƒêi·ªÅn t√™n + tu·ªïi + bio.", 
      check:(u,s)=> !!u.name && !!u.age && !!u.bio },

    { id:"coin_1k", icon:"üí∞", name:"Ti·ªÉu ph√∫", 
      desc:"ƒê·∫°t 1.000 xu.", check:(u,s)=> (u.coins||0) >= 1000 },

    { id:"coin_5k", icon:"üíé", name:"ƒê·∫°i gia m·ªõi n·ªïi", 
      desc:"ƒê·∫°t 5.000 xu.", check:(u,s)=> (u.coins||0) >= 5000 },

    { id:"coin_10k", icon:"üëë", name:"Tr√πm xu", 
      desc:"ƒê·∫°t 10.000 xu.", check:(u,s)=> (u.coins||0) >= 10000 },

    { id:"vip_1", icon:"‚≠ê", name:"VIP ƒë·∫ßu ƒë·ªùi", 
      desc:"S·ªü h·ªØu VIP t·ª´ c·∫•p 1 tr·ªü l√™n.", check:(u,s)=> (u.vipTier||0) >= 1 },

    { id:"vip_3", icon:"üåü", name:"VIP pro", 
      desc:"S·ªü h·ªØu VIP t·ª´ c·∫•p 3 tr·ªü l√™n.", check:(u,s)=> (u.vipTier||0) >= 3 },

    { id:"vip_6", icon:"üèÜ", name:"VIP t·ªëi th∆∞·ª£ng", 
      desc:"S·ªü h·ªØu VIP c·∫•p 6.", check:(u,s)=> (u.vipTier||0) >= 6 },

    { id:"first_match", icon:"üíó", name:"Match ƒë·∫ßu ti√™n", 
      desc:"C√≥ √≠t nh·∫•t 1 match.", check:(u,s)=> s.matchCount >= 1 },

    { id:"match_10", icon:"üíû", name:"Hot profile", 
      desc:"C√≥ 10 match.", check:(u,s)=> s.matchCount >= 10 },

    { id:"got_pet", icon:"üêæ", name:"Sen ch√≠nh hi·ªáu", 
      desc:"C√≥ pet ƒëang nu√¥i.", check:(u,s)=> !!u.activePet },

    { id:"pet_lv5", icon:"üêâ", name:"Pet th·∫ßn s·∫ßu", 
      desc:"Pet ƒë·∫°t level 5.", check:(u,s)=> (u.activePet?.level||0) >= 5 },

    { id:"got_house", icon:"üè†", name:"C√≥ ch·ªó che m∆∞a che n·∫Øng", 
      desc:"C√≥ nh√† ƒëang ·ªü.", check:(u,s)=> !!u.activeHouse },

    { id:"house_lv5", icon:"üè∞", name:"ƒê·∫°i gia nh√† ƒë·∫•t", 
      desc:"Nh√† ƒë·∫°t level 5.", check:(u,s)=> (u.activeHouse?.level||0) >= 5 },

    { id:"shop_first", icon:"üõí", name:"Mua s·∫Øm l·∫ßn ƒë·∫ßu", 
      desc:"C√≥ √≠t nh·∫•t 1 m√≥n trong kho ƒë·ªì.", check:(u,s)=> s.inventoryCount >= 1 },

    { id:"married", icon:"üíç", name:"V·ªÅ chung m·ªôt nh√†", 
      desc:"ƒê√£ k·∫øt h√¥n trong NearLove.", check:(u,s)=> !!u.marriedTo },
  ];

  let uid=null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!"); location.href="login.html"; return; }
    uid=user.uid;

    const userRef = doc(db,"users",uid);
    const snap = await getDoc(userRef);
    const u = snap.exists() ? snap.data() : {};

    // ==== T√çNH STATS PH·ª§ ====
    const stats = await computeStats(uid);

    // Render top bar
    coinsEl.innerText = u.coins||0;
    vipNowEl.innerText = u.vipTier ? `VIP ${u.vipTier} ‚Ä¢ ${u.vipName||""}` : "Th∆∞·ªùng";
    matchCountEl.innerText = stats.matchCount;
    marriedEl.innerText = u.marriedTo ? "‚úÖ C√≥" : "‚ùå Ch∆∞a";
    petNowEl.innerText = u.activePet ? `${u.activePet.icon||"üêæ"} Lv.${u.activePet.level||1}` : "‚ùå";
    houseNowEl.innerText = u.activeHouse ? `${u.activeHouse.icon||"üè†"} Lv.${u.activeHouse.level||1}` : "‚ùå";

    // ==== AUTO UNLOCK ====
    const unlocked = new Set(u.achievements || []);
    let newUnlocked = false;

    ACHS.forEach(a=>{
      if(!unlocked.has(a.id) && a.check(u, stats)){
        unlocked.add(a.id);
        newUnlocked = true;
      }
    });

    if(newUnlocked){
      await updateDoc(userRef, {
        achievements: Array.from(unlocked),
        achievementsUpdatedAt: serverTimestamp()
      });
      msgEl.style.color="lightgreen";
      msgEl.innerText="üéâ B·∫°n v·ª´a m·ªü kh√≥a th√™m th√†nh t√≠ch!";
    }else{
      msgEl.style.color="#aaa";
      msgEl.innerText="Ch∆∞a c√≥ th√†nh t√≠ch m·ªõi. Ti·∫øp t·ª•c ch∆°i nh√© üòÑ";
    }

    renderAchievements(Array.from(unlocked), stats);
  });

  // ==== T√çNH MATCH COUNT + INVENTORY COUNT ====
  async function computeStats(uid){
    // match count
    const mq = query(
      collection(db,"matches"),
      where("users","array-contains", uid)
    );
    const msnap = await getDocs(mq);
    const matchCount = msnap.size;

    // inventory count
    const invSnap = await getDoc(doc(db,"inventories", uid));
    const items = invSnap.exists() ? (invSnap.data().items || []) : [];
    const inventoryCount = items.length;

    return { matchCount, inventoryCount };
  }

  function renderAchievements(unlockedList, stats){
    const unlockedSet = new Set(unlockedList);

    achGrid.innerHTML = ACHS.map(a=>{
      const ok = unlockedSet.has(a.id);
      return `
        <div class="card ${ok?"unlocked":"locked"}">
          <div class="icon">${a.icon}</div>
          <div style="flex:1">
            <div class="name">${a.name}</div>
            <div class="desc">${a.desc}</div>
            <div class="meta">ID: ${a.id}</div>
            <div class="tag">${ok?"ƒê√£ m·ªü kh√≥a ‚úÖ":"Ch∆∞a m·ªü kh√≥a üîí"}</div>
          </div>
        </div>
      `;
    }).join("");
  }
</script>

</body>
</html>
