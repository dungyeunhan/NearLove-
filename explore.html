<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>NearLove - Kh√°m ph√°</title>
<link rel="stylesheet" href="theme.css">
<style>
  .filter-box{margin-bottom:12px;}
  .filter-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;}
  .filter-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:8px;}
  .user-card{display:flex;flex-direction:column;gap:8px;}
  .score{font-size:12px;font-weight:900;color:#ffd1e6;}
</style>
</head>
<body>

<div class="container">

  <h2>üíû Kh√°m ph√° ng∆∞·ªùi m·ªõi</h2>

  <!-- FILTERS -->
  <div class="box filter-box">
    <div style="font-weight:900;margin-bottom:4px;">B·ªô l·ªçc</div>

    <input id="searchName" placeholder="T√¨m theo t√™n...">

    <div class="filter-row">
      <select id="genderFilter">
        <option value="all">T·∫•t c·∫£ gi·ªõi t√≠nh</option>
        <option value="nam">Nam</option>
        <option value="n·ªØ">N·ªØ</option>
        <option value="kh√°c">Kh√°c</option>
      </select>

      <select id="vipFilter">
        <option value="all">T·∫•t c·∫£ VIP</option>
        <option value="0">Th∆∞·ªùng</option>
        <option value="1">VIP 1+</option>
        <option value="3">VIP 3+</option>
        <option value="5">VIP 5+</option>
        <option value="6">VIP 6</option>
      </select>
    </div>

    <div class="filter-row-3">
      <input id="minAge" type="number" placeholder="Tu·ªïi min">
      <input id="maxAge" type="number" placeholder="Tu·ªïi max">
      <button class="btn light" id="applyBtn">√Åp d·ª•ng</button>
    </div>

    <div class="muted" style="margin-top:6px;">
      * AI g·ª£i √Ω s·∫Ω t·ª± s·∫Øp x·∫øp ng∆∞·ªùi h·ª£p nh·∫•t l√™n ƒë·∫ßu.
    </div>
  </div>

  <!-- LIST -->
  <div id="list" class="grid-2"></div>
  <p id="empty" class="muted" style="text-align:center;display:none;">Kh√¥ng c√≥ ai ph√π h·ª£p b·ªô l·ªçc üòÖ</p>

</div>

<script type="module" src="firebase.js"></script>
<script src="theme.js"></script>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
  import {
    collection, onSnapshot, doc, getDoc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

  const listDiv = document.getElementById("list");
  const emptyEl = document.getElementById("empty");

  const searchNameEl = document.getElementById("searchName");
  const genderFilterEl = document.getElementById("genderFilter");
  const vipFilterEl = document.getElementById("vipFilter");
  const minAgeEl = document.getElementById("minAge");
  const maxAgeEl = document.getElementById("maxAge");
  const applyBtn = document.getElementById("applyBtn");

  let currentUid = null;
  let meProfile = null;
  let allUsers = [];

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
      location.href = "login.html";
      return;
    }

    currentUid = user.uid;

    // load profile m√¨nh (ƒë·ªÉ AI g·ª£i √Ω)
    const meSnap = await getDoc(doc(db, "users", currentUid));
    meProfile = meSnap.exists() ? meSnap.data() : {};

    // realtime load to√†n b·ªô users
    onSnapshot(collection(db, "users"), (snap) => {
      allUsers = [];
      snap.forEach(d => {
        const u = d.data();
        const uid = d.id;

        if (uid === currentUid) return;
        if (u.hidden) return;

        allUsers.push({ uid, ...u });
      });

      render();
    });
  });

  applyBtn.onclick = render;
  searchNameEl.oninput = render;
  genderFilterEl.onchange = render;
  vipFilterEl.onchange = render;

  function render(){
    if(!meProfile) return;

    // 1) l·ªçc theo filter
    const filtered = allUsers.filter(u => {
      // search name
      const kw = searchNameEl.value.trim().toLowerCase();
      if(kw && !(u.name||"").toLowerCase().includes(kw)) return false;

      // gender
      const gf = genderFilterEl.value;
      if(gf !== "all"){
        const g = (u.gender||"").toLowerCase();
        if(g !== gf) return false;
      }

      // vip
      const vf = vipFilterEl.value;
      const tier = u.vipTier || 0;
      if(vf !== "all"){
        const v = Number(vf);
        if(v === 6 && tier !== 6) return false;
        if(v !== 6 && tier < v) return false;
      }

      // age range
      const minA = Number(minAgeEl.value || 0);
      const maxA = Number(maxAgeEl.value || 999);
      const age = Number(u.age || 0);
      if(age && (age < minA || age > maxA)) return false;

      return true;
    });

    // 2) AI score + sort
    const scored = filtered.map(u => ({
      ...u,
      score: calcScore(meProfile, u)
    })).sort((a,b)=> b.score - a.score);

    // 3) render list
    listDiv.innerHTML = "";
    if(scored.length===0){
      emptyEl.style.display="block";
      return;
    }
    emptyEl.style.display="none";

    scored.forEach(u=>{
      const vipTier = u.vipTier||0;
      const vipColor = getVipColor(vipTier);
      const petText = u.activePet ? `${u.activePet.icon||"üêæ"} ${u.activePet.name} Lv.${u.activePet.level||1}`:"";
      const houseText = u.activeHouse ? `${u.activeHouse.icon||"üè†"} ${u.activeHouse.name} Lv.${u.activeHouse.level||1}`:"";

      const card = document.createElement("div");
      card.className = "card user-card fade-in";

      card.innerHTML = `
        <img src="${u.avatar || 'default.png'}" style="width:100%;border-radius:14px;">
        <div style="font-weight:900;font-size:18px;color:${vipColor}">
          ${u.name || "Ch∆∞a ƒë·∫∑t t√™n"} ${vipTier?`üëëVIP${vipTier}`:""}
        </div>
        <div class="muted">
          ${u.gender?`‚Ä¢ ${u.gender}`:""} ${u.age?`‚Ä¢ ${u.age} tu·ªïi`:""}
          ${petText?`<br>Pet: ${petText}`:""}
          ${houseText?`<br>Nh√†: ${houseText}`:""}
        </div>
        <div class="score">AI h·ª£p nhau: ${u.score} ƒëi·ªÉm</div>

        <button class="btn" onclick="likeUser('${u.uid}')">üíó Th·∫£ tim</button>
        <button class="btn light" onclick="location.href='profile_public.html?uid=${u.uid}'">üë§ Xem h·ªì s∆°</button>
      `;

      listDiv.appendChild(card);
      // check match ƒë·ªÉ hi·ªán n√∫t chat
      checkMatch(u.uid).then(matchId=>{
        if(matchId){
          const chatBtn=document.createElement("button");
          chatBtn.className="btn blue";
          chatBtn.innerText="üí¨ Chat ngay";
          chatBtn.onclick=()=>location.href=`chat.html?match=${matchId}`;
          card.appendChild(chatBtn);
        }
      });
    });
  }

  // ===== Like (y nh∆∞ B7) =====
  window.likeUser = async (targetUid) => {
    const myUid = currentUid;
    if (myUid === targetUid) return;

    await setDoc(doc(db, "likes", `${myUid}_${targetUid}`), {
      from: myUid, to: targetUid, time: serverTimestamp()
    });

    const reverse = await getDoc(doc(db, "likes", `${targetUid}_${myUid}`));
    if (reverse.exists()) {
      const matchId = `${myUid}_${targetUid}`;
      await setDoc(doc(db, "matches", matchId), {
        users: [myUid, targetUid], time: serverTimestamp()
      });
      alert("üéâ MATCH TH√ÄNH C√îNG!");
      render();
    } else {
      alert("üíó ƒê√£ th·∫£ tim! Ch·ªù ƒë·ªëi ph∆∞∆°ng th·∫£ tim l·∫°i.");
    }
  };

  async function checkMatch(otherUid) {
    const myUid = currentUid;
    const m1 = await getDoc(doc(db, "matches", `${myUid}_${otherUid}`));
    if (m1.exists()) return `${myUid}_${otherUid}`;
    const m2 = await getDoc(doc(db, "matches", `${otherUid}_${myUid}`));
    if (m2.exists()) return `${otherUid}_${myUid}`;
    return null;
  }

  // ===== MVP AI SCORE =====
  function calcScore(me, other){
    let score = 0;

    const myAge = Number(me.age||0);
    const oAge = Number(other.age||0);

    // 1) tu·ªïi g·∫ßn nhau (+40)
    if(myAge && oAge){
      const diff = Math.abs(myAge - oAge);
      if(diff <= 2) score += 40;
      else if(diff <= 5) score += 30;
      else if(diff <= 8) score += 20;
      else if(diff <= 12) score += 10;
    }else{
      score += 10; // ch∆∞a ƒë·ªß info v·∫´n cho nh·∫π
    }

    // 2) ∆∞u ti√™n VIP ngang/t∆∞∆°ng ƒë·ªëi (+25)
    const myVip = me.vipTier||0;
    const oVip = other.vipTier||0;
    const vipDiff = Math.abs(myVip - oVip);
    if(vipDiff===0) score += 25;
    else if(vipDiff<=2) score += 15;
    else score += 5;

    // 3) pet gi·ªëng lo·∫°i (bonus +10)
    if(me.activePet && other.activePet){
      if(me.activePet.id === other.activePet.id) score += 10;
      else score += 5;
    }

    // 4) house level g·∫ßn nhau (bonus +10)
    if(me.activeHouse && other.activeHouse){
      const hdiff = Math.abs((me.activeHouse.level||1)-(other.activeHouse.level||1));
      if(hdiff<=1) score += 10;
      else if(hdiff<=3) score += 6;
      else score += 2;
    }

    // 5) bonus n·∫øu ƒë·ªëi ph∆∞∆°ng c√≥ bio ƒë·∫ßy ƒë·ªß (+5)
    if(other.bio && other.bio.length>=10) score += 5;

    return score;
  }

  function getVipColor(tier){
    if(tier>=6) return "#ffd700";
    if(tier==5) return "#ff8ac9";
    if(tier==4) return "#b388ff";
    if(tier==3) return "#7bdff2";
    if(tier==2) return "#7ee081";
    if(tier==1) return "#ffffff";
    return "#ffffff";
  }
</script>

<!-- NAV + GUARD -->
<script type="module">
  import { renderNav } from "./nav.js";
  import { requireAuth } from "./guard.js";
  requireAuth();
  renderNav("explore");
</script>

</body>
</html>
